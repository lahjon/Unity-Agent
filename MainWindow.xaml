<Window x:Class="HappyEngine.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:HappyEngine"
        xmlns:controls="clr-namespace:HappyEngine.Controls"
        Title="Happy Engine" Width="1280" Height="820"
        Background="{StaticResource BgDeep}" WindowStartupLocation="CenterScreen"
        Loaded="Window_Loaded"
        PreviewKeyDown="Window_PreviewKeyDown">

    <Window.Resources>
        <!-- ═══ ACTIVE TASK ═══ -->
        <DataTemplate x:Key="ActiveTaskTemplate">
            <Border x:Name="Card" CornerRadius="8" Padding="10"
                    Margin="{Binding NestingDepth, Converter={StaticResource NestingDepthToMargin}}"
                    BorderThickness="1"
                    MouseUp="TaskCard_MouseUp"
                    PreviewMouseLeftButtonDown="TaskCard_PreviewMouseDown"
                    MouseMove="TaskCard_MouseMove"
                    AllowDrop="True"
                    DragOver="TaskCard_DragOver"
                    Drop="TaskCard_Drop">
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Copy Prompt" Click="CopyPrompt_Click"/>
                        <MenuItem Header="Revert Changes" Click="RevertTask_Click"/>
                        <Separator/>
                        <MenuItem Header="Priority">
                            <MenuItem Header="Critical" Click="SetPriorityCritical_Click"/>
                            <MenuItem Header="High" Click="SetPriorityHigh_Click"/>
                            <MenuItem Header="Normal" Click="SetPriorityNormal_Click"/>
                            <MenuItem Header="Low" Click="SetPriorityLow_Click"/>
                        </MenuItem>
                    </ContextMenu>
                </Border.ContextMenu>
                <Border.Background>
                    <SolidColorBrush x:Name="CardBg" Color="#222222"/>
                </Border.Background>
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="CardBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="CardBg" Storyboard.TargetProperty="Color"
                                                To="#2A2A2A" Duration="0:0:0.15"/>
                                <ColorAnimation Storyboard.TargetName="CardBorder" Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.15"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="CardBg" Storyboard.TargetProperty="Color"
                                                To="#222222" Duration="0:0:0.2"/>
                                <ColorAnimation Storyboard.TargetName="CardBorder" Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <!-- Top-right buttons -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal"
                                HorizontalAlignment="Right" VerticalAlignment="Top"
                                Margin="0,-2,-2,0">
                        <!-- Force-start button (visible on queued/init-queued tasks) -->
                        <Button Click="ForceStartQueued_Click" Margin="0,0,2,0">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE768;"/>
                                    <Setter Property="Foreground" Value="#FFD600"/>
                                    <Setter Property="ToolTip" Value="Force start (bypass queue)"/>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsQueued}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsInitQueued}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <!-- Pause/Resume button -->
                        <Button Click="Pause_Click" Margin="0,0,2,0">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE769;"/>
                                    <Setter Property="Foreground" Value="{StaticResource Accent}"/>
                                    <Setter Property="ToolTip" Value="Pause task"/>
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPaused}" Value="True">
                                            <Setter Property="Content" Value="&#xE768;"/>
                                            <Setter Property="Foreground" Value="{StaticResource AccentHover}"/>
                                            <Setter Property="ToolTip" Value="Resume task"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsFinished}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsQueued}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsInitQueued}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsPlanning}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <!-- Verify button (visible when finished) -->
                        <Button Click="VerifyTask_Click" Margin="0,0,2,0" FontSize="11">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE721;"/>
                                    <Setter Property="ToolTip" Value="Run result verification"/>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsFinished}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <!-- Close/Remove button -->
                        <Button Click="Cancel_Click">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE8BB;"/>
                                    <Setter Property="ToolTip" Value="Cancel task"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsFinished}" Value="True">
                                            <Setter Property="Content" Value="&#xE73E;"/>
                                            <Setter Property="Foreground" Value="{StaticResource Success}"/>
                                            <Setter Property="ToolTip" Value="Remove task"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                    <StackPanel Grid.Row="0" Orientation="Horizontal">
                        <Grid Width="8" Height="8" Margin="0,0,6,0" VerticalAlignment="Center">
                            <Ellipse x:Name="StatusGlow" Width="8" Height="8"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Effect">
                                            <Setter.Value>
                                                <BlurEffect Radius="0"/>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRunning}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="GlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="10" Duration="0:0:0.8"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1.0" Duration="0:0:0.8"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="GlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsQueued}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="QueuedGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="8" Duration="0:0:1.2"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.4" To="1.0" Duration="0:0:1.2"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="QueuedGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsInitQueued}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="InitQueuedGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1.0" Duration="0:0:1.5"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="InitQueuedGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsPaused}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="PausedGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1.0" Duration="0:0:2.0"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="PausedGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsPlanning}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="PlanningGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="8" Duration="0:0:1.0"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.4" To="1.0" Duration="0:0:1.0"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="PlanningGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <Ellipse x:Name="StatusDot" Width="8" Height="8"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}"/>
                        </Grid>
                        <TextBlock Text="{Binding StatusText}"
                                   Foreground="{Binding StatusColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="11" FontWeight="SemiBold" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text=" | " Foreground="{StaticResource SeparatorDark}" FontSize="11" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ProjectName}" Foreground="{Binding ProjectColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="11" FontFamily="Segoe UI" VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis" MaxWidth="100"
                                   ToolTip="{Binding ProjectPath}"/>
                        <TextBlock Text="{Binding HierarchyLabel}"
                                   Foreground="{StaticResource TextSubdued}"
                                   FontSize="10" FontFamily="Consolas" Margin="8,0,0,0"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Grid.Row="1" Text="{Binding ShortDescription}"
                               Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                               TextTrimming="CharacterEllipsis" Margin="0,4,0,0">
                        <TextBlock.ToolTip>
                            <ToolTip MaxWidth="600" Placement="Bottom">
                                <TextBlock Text="{Binding Description}" TextWrapping="Wrap" MaxWidth="580"/>
                            </ToolTip>
                        </TextBlock.ToolTip>
                    </TextBlock>
                    <!-- Tool activity feed + token usage -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" Margin="0,4,0,0">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsRunning}" Value="True"/>
                                            <Condition Binding="{Binding HasToolActivity}" Value="True"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>
                                    <DataTrigger Binding="{Binding HasTokenData}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        <TextBlock Text="{Binding ToolActivityText}"
                                   Foreground="{StaticResource ToolActivityText}" FontSize="10" FontFamily="Consolas"
                                   TextTrimming="CharacterEllipsis" MaxWidth="200"
                                   LineHeight="15">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding IsRunning}" Value="True"/>
                                                <Condition Binding="{Binding HasToolActivity}" Value="True"/>
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </MultiDataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBlock Text=" | " Foreground="{StaticResource SeparatorDark}" FontSize="10" FontFamily="Consolas">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <MultiDataTrigger>
                                            <MultiDataTrigger.Conditions>
                                                <Condition Binding="{Binding IsRunning}" Value="True"/>
                                                <Condition Binding="{Binding HasToolActivity}" Value="True"/>
                                                <Condition Binding="{Binding HasTokenData}" Value="True"/>
                                            </MultiDataTrigger.Conditions>
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </MultiDataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                        <TextBlock Text="{Binding TokenDisplayText}"
                                   Foreground="#8899AA" FontSize="10" FontFamily="Consolas"
                                   LineHeight="15">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding HasTokenData}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </StackPanel>
                    <Grid Grid.Row="3" Margin="0,6,0,0">
                        <TextBlock Text="{Binding TimeInfo}" Foreground="{StaticResource TextMuted}"
                                   FontSize="10" VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                            <!-- File lock padlock toggle -->
                            <Button Click="ToggleFileLock_Click" VerticalAlignment="Center" Margin="0,0,4,0">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                        <Setter Property="Content" Value="&#xE72E;"/>
                                        <Setter Property="Foreground" Value="#64B5F6"/>
                                        <Setter Property="ToolTip" Value="File locks enforced — click to ignore"/>
                                        <Setter Property="FontSize" Value="11"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IgnoreFileLocks}" Value="True">
                                                <Setter Property="Content" Value="&#xE785;"/>
                                                <Setter Property="Foreground" Value="#666666"/>
                                                <Setter Property="ToolTip" Value="File locks ignored — click to enforce"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                            <Border CornerRadius="3" Padding="4,1"
                                    Background="{StaticResource PlanBadgeBg}" BorderBrush="{StaticResource PlanBadgeBorder}" BorderThickness="1">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding PlanOnly}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="PLAN" Foreground="{StaticResource PlanBadgeText}" FontSize="9"
                                           FontFamily="Segoe UI" FontWeight="Bold"/>
                            </Border>
                            <!-- Per-task toggle badges -->
                            <Border CornerRadius="3" Padding="4,1" Margin="4,0,0,0"
                                    Background="#33607D8B" BorderBrush="#55607D8B" BorderThickness="1">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasActiveToggles}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="{Binding ActiveTogglesText}" Foreground="#90A4AE" FontSize="9"
                                           FontFamily="Segoe UI" FontWeight="Bold"/>
                            </Border>
                            <!-- Priority badge -->
                            <Border CornerRadius="3" Padding="4,1" Margin="4,0,0,0"
                                    BorderThickness="1">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Setter Property="Background" Value="#33FFD600"/>
                                        <Setter Property="BorderBrush" Value="#55FFD600"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasPriorityBadge}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding PriorityLevel}" Value="Critical">
                                                <Setter Property="Background" Value="#33FF5252"/>
                                                <Setter Property="BorderBrush" Value="#55FF5252"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding PriorityLevel}" Value="Low">
                                                <Setter Property="Background" Value="#3378909C"/>
                                                <Setter Property="BorderBrush" Value="#5578909C"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="{Binding PriorityBadgeText}"
                                           Foreground="{Binding PriorityBadgeColor, Converter={StaticResource StringToBrush}}"
                                           FontSize="9" FontFamily="Segoe UI" FontWeight="Bold"/>
                            </Border>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- ═══ HISTORY TASK ═══ -->
        <DataTemplate x:Key="HistoryTaskTemplate">
            <Border CornerRadius="8" Padding="10" Margin="0,2"
                    BorderThickness="1">
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Resume" Click="Resume_Click"/>
                        <MenuItem Header="Re-run Task" Click="RerunTask_Click"/>
                        <MenuItem Header="Store Task" Click="StoreHistoryTask_Click"/>
                        <Separator/>
                        <MenuItem Header="Copy Prompt" Click="CopyPrompt_Click"/>
                        <MenuItem Header="Revert Changes" Click="RevertTask_Click"/>
                    </ContextMenu>
                </Border.ContextMenu>
                <Border.Background>
                    <SolidColorBrush x:Name="HistCardBg" Color="#222222"/>
                </Border.Background>
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="HistCardBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="HistCardBg" Storyboard.TargetProperty="Color"
                                                To="#282828" Duration="0:0:0.15"/>
                                <ColorAnimation Storyboard.TargetName="HistCardBorder" Storyboard.TargetProperty="Color"
                                                To="#383838" Duration="0:0:0.15"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="HistCardBg" Storyboard.TargetProperty="Color"
                                                To="#222222" Duration="0:0:0.2"/>
                                <ColorAnimation Storyboard.TargetName="HistCardBorder" Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <!-- Top-right buttons -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal"
                                HorizontalAlignment="Right" VerticalAlignment="Top"
                                Margin="0,-2,-2,0">
                        <!-- Verify button (visible when finished) -->
                        <Button Click="VerifyTask_Click" Margin="0,0,2,0" FontSize="11">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE721;"/>
                                    <Setter Property="ToolTip" Value="Run result verification"/>
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsFinished}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <!-- Close X button -->
                        <Button Content="&#xE8BB;" Click="RemoveHistoryTask_Click"
                                Style="{StaticResource IconBtn}"
                                ToolTip="Remove from history"/>
                    </StackPanel>
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="14,0,0,0">
                        <Grid Width="8" Height="8" Margin="0,0,6,0" VerticalAlignment="Center">
                            <Ellipse x:Name="HistStatusGlow" Width="8" Height="8"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Effect">
                                            <Setter.Value>
                                                <BlurEffect Radius="0"/>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRunning}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="HistGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="10" Duration="0:0:0.8"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1.0" Duration="0:0:0.8"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="HistGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsQueued}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="HistQueuedGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="8" Duration="0:0:1.2"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.4" To="1.0" Duration="0:0:1.2"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="HistQueuedGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <Ellipse x:Name="HistStatusDot" Width="8" Height="8"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}"/>
                        </Grid>
                        <TextBlock Text="{Binding StatusText}"
                                   Foreground="{Binding StatusColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="11" FontWeight="SemiBold" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text=" | " Foreground="{StaticResource SeparatorDark}" FontSize="11" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ProjectName}" Foreground="{Binding ProjectColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="11" FontFamily="Segoe UI" VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis" MaxWidth="100"
                                   ToolTip="{Binding ProjectPath}"/>
                        <TextBlock Text="{Binding TaskNumber, StringFormat='#{0:D4}'}"
                                   Foreground="{StaticResource TextMuted}"
                                   FontSize="10" FontFamily="Consolas" Margin="8,0,0,0"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Grid.Row="1" Text="{Binding ShortDescription}"
                               Foreground="{StaticResource TextSubdued}" FontSize="12" FontFamily="Segoe UI"
                               TextTrimming="CharacterEllipsis" Margin="0,4,0,0">
                        <TextBlock.ToolTip>
                            <ToolTip MaxWidth="600" Placement="Bottom">
                                <TextBlock Text="{Binding Description}" TextWrapping="Wrap" MaxWidth="580"/>
                            </ToolTip>
                        </TextBlock.ToolTip>
                    </TextBlock>
                    <!-- Recommendations / Next Steps -->
                    <TextBlock Grid.Row="2" Text="{Binding Recommendations}"
                               Foreground="#80CBC4" FontSize="10" FontFamily="Segoe UI"
                               TextWrapping="Wrap" TextTrimming="CharacterEllipsis"
                               MaxHeight="40" Margin="0,4,0,0">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding HasRecommendations}" Value="True">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                        <TextBlock.ToolTip>
                            <ToolTip MaxWidth="600" Placement="Bottom">
                                <TextBlock Text="{Binding Recommendations}" TextWrapping="Wrap" MaxWidth="580"
                                           Foreground="#B2DFDB"/>
                            </ToolTip>
                        </TextBlock.ToolTip>
                    </TextBlock>
                    <Grid Grid.Row="3" Margin="0,6,0,0">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <TextBlock Text="{Binding TimeInfo}" Foreground="{StaticResource TextDisabled}"
                                       FontSize="10" FontFamily="Segoe UI"/>
                            <TextBlock Text=" | " Foreground="{StaticResource SeparatorDark}" FontSize="10" FontFamily="Segoe UI">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasTokenData}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                            <TextBlock Text="{Binding TokenDisplayText}" Foreground="#8899AA"
                                       FontSize="10" FontFamily="Consolas">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasTokenData}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <!-- Per-task toggle badges -->
                            <Border CornerRadius="3" Padding="4,1" Margin="0,0,4,0"
                                    Background="#33607D8B" BorderBrush="#55607D8B" BorderThickness="1"
                                    VerticalAlignment="Center">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding HasActiveToggles}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="{Binding ActiveTogglesText}" Foreground="#90A4AE" FontSize="9"
                                           FontFamily="Segoe UI" FontWeight="Bold"/>
                            </Border>
                            <Border CornerRadius="3" Padding="4,1" Margin="0,0,8,0"
                                    Background="{StaticResource PlanBadgeBg}" BorderBrush="{StaticResource PlanBadgeBorder}" BorderThickness="1"
                                    VerticalAlignment="Center">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding PlanOnly}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="PLAN" Foreground="{StaticResource PlanBadgeText}" FontSize="9"
                                           FontFamily="Segoe UI" FontWeight="Bold"/>
                            </Border>
                            <Button Content="Retry" Click="RetryTask_Click"
                                    Background="#E07840"
                                    Margin="0,0,4,0">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource SmallBtn}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRetryable}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Button.Style>
                            </Button>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- ═══ STORED TASK ═══ -->
        <DataTemplate x:Key="StoredTaskTemplate">
            <Border CornerRadius="8" Padding="10" Margin="0,2"
                    BorderThickness="1">
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Copy Stored Prompt" Click="CopyStoredPrompt_Click"/>
                        <MenuItem Header="Copy Original Prompt" Click="CopyPrompt_Click"/>
                    </ContextMenu>
                </Border.ContextMenu>
                <Border.Background>
                    <SolidColorBrush x:Name="StoredCardBg" Color="#1E2428"/>
                </Border.Background>
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="StoredCardBorder" Color="#2A3A3A"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="StoredCardBg" Storyboard.TargetProperty="Color"
                                                To="#253030" Duration="0:0:0.15"/>
                                <ColorAnimation Storyboard.TargetName="StoredCardBorder" Storyboard.TargetProperty="Color"
                                                To="#3A4A4A" Duration="0:0:0.15"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="StoredCardBg" Storyboard.TargetProperty="Color"
                                                To="#1E2428" Duration="0:0:0.2"/>
                                <ColorAnimation Storyboard.TargetName="StoredCardBorder" Storyboard.TargetProperty="Color"
                                                To="#2A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <!-- Close X button top-right -->
                    <Button Grid.Row="0" Content="&#xE8BB;" Click="RemoveStoredTask_Click"
                            HorizontalAlignment="Right" VerticalAlignment="Top"
                            Style="{StaticResource IconBtn}" Margin="0,-2,-2,0"
                            ToolTip="Remove stored task"/>
                    <StackPanel Grid.Row="0" Orientation="Horizontal">
                        <Grid Width="8" Height="8" Margin="0,0,6,0" VerticalAlignment="Center">
                            <Ellipse Width="8" Height="8" Fill="{StaticResource AccentTeal}"/>
                        </Grid>
                        <TextBlock Text="Stored" Foreground="{StaticResource AccentTeal}"
                                   FontSize="11" FontWeight="SemiBold" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text=" | " Foreground="{StaticResource SeparatorDark}" FontSize="11" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ProjectName}" Foreground="{Binding ProjectColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="11" FontFamily="Segoe UI" VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis" MaxWidth="100"
                                   ToolTip="{Binding ProjectPath}"/>
                        <TextBlock Text="{Binding TaskNumber, StringFormat='#{0:D4}'}"
                                   Foreground="{StaticResource TextMuted}"
                                   FontSize="10" FontFamily="Consolas" Margin="8,0,0,0"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Grid.Row="1" Text="{Binding ShortDescription}"
                               Foreground="{StaticResource TextSubdued}" FontSize="12" FontFamily="Segoe UI"
                               TextTrimming="CharacterEllipsis" Margin="0,4,0,0">
                        <TextBlock.ToolTip>
                            <ToolTip MaxWidth="600" Placement="Bottom">
                                <TextBlock Text="{Binding StoredPrompt}" TextWrapping="Wrap" MaxWidth="580"/>
                            </ToolTip>
                        </TextBlock.ToolTip>
                    </TextBlock>
                    <Grid Grid.Row="2" Margin="0,6,0,0">
                        <TextBlock Text="{Binding TimeInfo}" Foreground="{StaticResource TextDisabled}"
                                   FontSize="10" VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="View" Click="ViewStoredTask_Click"
                                    Background="{StaticResource BorderSubtle}" Style="{StaticResource SmallBtn}"
                                    Margin="0,0,6,0"/>
                            <Button Content="Execute" Click="ExecuteStoredTask_Click"
                                    Background="{StaticResource AccentTeal}" Style="{StaticResource SmallBtn}"
                                    Margin="0"/>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>
        <!-- ═══ SAVED PROMPT CARD ═══ -->
        <DataTemplate x:Key="SavedPromptTemplate">
            <Border CornerRadius="4" Padding="6,5,6,5" Margin="0,0,0,4" Cursor="Hand"
                    MouseLeftButtonDown="SavedPromptCard_MouseLeftButtonDown"
                    MouseDown="SavedPromptCard_MouseDown">
                <Border.Style>
                    <Style TargetType="Border">
                        <Setter Property="Background" Value="{StaticResource BgPopup}"/>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource BgCardHover}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Run" Click="SavedPromptRun_Click"/>
                        <MenuItem Header="Copy Prompt" Click="SavedPromptCopy_Click"/>
                    </ContextMenu>
                </Border.ContextMenu>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <TextBlock Grid.Column="0" Text="{Binding DisplayName}"
                               Foreground="{StaticResource TextLight}" FontSize="11"
                               FontFamily="Segoe UI" TextTrimming="CharacterEllipsis"
                               VerticalAlignment="Center"
                               ToolTip="{Binding PromptText, Converter={StaticResource WrapTooltipText}}"/>
                    <Button Grid.Column="1" Content="X" FontSize="9" FontWeight="Bold"
                            Background="Transparent" BorderThickness="0" Cursor="Hand"
                            Padding="4,1,4,1" VerticalAlignment="Center"
                            Click="DeleteSavedPrompt_Click">
                        <Button.Style>
                            <Style TargetType="Button">
                                <Setter Property="Foreground" Value="{StaticResource TextSubdued}"/>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Foreground" Value="{StaticResource DangerDeleteHover}"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </Button.Style>
                    </Button>
                </Grid>
            </Border>
        </DataTemplate>

    </Window.Resources>

    <Grid x:Name="RootGrid" Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" MinHeight="120"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="150" MinHeight="60"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition x:Name="TerminalRow" Height="Auto" MinHeight="0"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="285" MinWidth="150"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*" MinWidth="200"/>
            <ColumnDefinition x:Name="ChatSplitterCol" Width="0"/>
            <ColumnDefinition x:Name="ChatPanelCol" Width="0" MinWidth="0"/>
            <ColumnDefinition x:Name="RightSplitterCol" Width="Auto"/>
            <ColumnDefinition x:Name="RightPanelCol" Width="285" MinWidth="150"/>
        </Grid.ColumnDefinitions>

        <!-- ═══ PROJECTS (1) ═══ -->
        <Border Grid.Row="2" Grid.Column="0" Grid.RowSpan="3" Background="{StaticResource BgSurface}" CornerRadius="8" Padding="10"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="ProjectsPanelBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="ProjectsPanelBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="ProjectsPanelBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <DockPanel>
                    <!-- Add / Create Project form -->
                    <Border DockPanel.Dock="Bottom" Background="{StaticResource BgSection}" CornerRadius="6"
                            BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1" Margin="0,6,0,0" Padding="8">
                        <StackPanel>
                            <Border Background="{StaticResource BgDeep}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                    CornerRadius="2" Cursor="Hand"
                                    MouseLeftButtonDown="AddProjectPath_Click">
                                <TextBlock x:Name="AddProjectPath"
                                           Foreground="{StaticResource TextMuted}" FontSize="11"
                                           FontFamily="Segoe UI" Padding="6,4"
                                           Text="Click to add project folder..."
                                           VerticalAlignment="Center"/>
                            </Border>
                            <Button Content="Create New Project" Click="CreateProject_Click"
                                    Background="{StaticResource Accent}" Style="{StaticResource SmallBtn}"
                                    HorizontalAlignment="Stretch" Margin="0,6,0,0" Padding="10,5"/>
                        </StackPanel>
                    </Border>
                    <!-- Header -->
                    <TextBlock DockPanel.Dock="Top" Text="PROJECTS" Foreground="{StaticResource Accent}" FontWeight="Bold"
                               FontSize="10" FontFamily="Segoe UI" Margin="4,2,0,6"/>
                    <!-- Project list -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel x:Name="ProjectListPanel" Margin="0"/>
                    </ScrollViewer>
                </DockPanel>
            </Border>

        <!-- Vertical Splitter: Left ↔ Center/Right -->
        <GridSplitter Grid.Column="1" Grid.RowSpan="5" Style="{StaticResource VerticalSplitter}"/>

        <!-- ═══ PROMPTS (2) ═══ -->
        <Border Grid.Row="2" Grid.Column="2" Background="{StaticResource BgSurface}" CornerRadius="8" Padding="10"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="InputSectionBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="InputSectionBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="InputSectionBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition x:Name="SavedPanelCol" Width="200" MinWidth="120"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left: Prompt input area + collapsible Advanced side panel -->
                <Grid Grid.Column="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Prompt area -->
                <DockPanel Grid.Column="1">
                    <!-- Bottom: Advanced toggle + Execute button (always visible) -->
                    <DockPanel DockPanel.Dock="Bottom" Margin="0,4,0,0">
                        <StackPanel DockPanel.Dock="Right" Margin="10,0,0,0" VerticalAlignment="Top">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <TextBlock x:Name="PromptProjectLabel" Text="" Foreground="{StaticResource TextPrimary}" FontFamily="Segoe UI"
                                           FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center" Margin="0,0,12,0"
                                           TextTrimming="CharacterEllipsis" MaxWidth="400"/>
                                <Button Content="Save Prompt" Click="SavePromptEntry_Click"
                                        Background="{StaticResource BgHover}" Style="{StaticResource Btn}"
                                        Foreground="#A8A8A8"
                                        FontSize="11" Padding="6,4" Margin="0,0,6,0"/>
                                <Button x:Name="ExecuteButton" Content="Execute Task" Click="Execute_Click"
                                        Background="{StaticResource Accent}" Style="{StaticResource Btn}"
                                        FontSize="13" Padding="18,6" FontWeight="Bold"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,2,0,0">
                                <TextBlock Text="Ctrl+S to save" Foreground="{StaticResource TextDisabled}" FontFamily="Segoe UI"
                                           FontSize="10" Margin="0,0,12,0"/>
                                <TextBlock Text="Ctrl+Enter to execute" Foreground="{StaticResource TextDisabled}" FontFamily="Segoe UI"
                                           FontSize="10"/>
                            </StackPanel>
                        </StackPanel>
                        <Button x:Name="AdvancedToggleBtn" Click="AdvancedToggle_Click"
                                Background="Transparent" BorderThickness="0" Cursor="Hand"
                                HorizontalAlignment="Left" VerticalAlignment="Center" Padding="0,4">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock x:Name="AdvancedArrow" Text="&#x25C2;" Foreground="{StaticResource Accent}"
                                           FontSize="11" FontWeight="Bold" Margin="0,0,6,0" VerticalAlignment="Center"/>
                                <TextBlock Text="ADVANCED" Foreground="{StaticResource Accent}" FontWeight="Bold" FontSize="10"
                                           FontFamily="Segoe UI" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </DockPanel>
                    <!-- Top: Prompt label, model selector, text input -->
                    <DockPanel>
                        <!-- Panel label + Model selector -->
                        <DockPanel DockPanel.Dock="Top" Margin="0,0,0,4">
                            <TextBlock Text="PROMPT" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                       FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                            <TextBlock Text="MODEL" Foreground="{StaticResource TextMuted}" FontWeight="Bold"
                                       FontSize="9" FontFamily="Segoe UI" VerticalAlignment="Center"
                                       Margin="20,0,6,0"/>
                            <ComboBox x:Name="ModelCombo" SelectedIndex="0"
                                      FontSize="11" Padding="6,3" MinWidth="170"
                                      HorizontalAlignment="Left"
                                      SelectionChanged="ModelCombo_Changed">
                                <ComboBoxItem Content="Claude Code" Tag="ClaudeCode"/>
                                <ComboBoxItem Content="Gemini (Image Gen)" Tag="Gemini"/>
                                <ComboBoxItem Content="Gemini (Game Art)" Tag="GeminiGameArt"/>
                            </ComboBox>
                            <TextBlock x:Name="AssetTypeLabel" Text="ASSET" Foreground="{StaticResource TextMuted}" FontWeight="Bold"
                                       FontSize="9" FontFamily="Segoe UI" VerticalAlignment="Center"
                                       Margin="12,0,6,0" Visibility="Collapsed"/>
                            <ComboBox x:Name="AssetTypeCombo" SelectedIndex="0"
                                      FontSize="11" Padding="6,3" MinWidth="120"
                                      HorizontalAlignment="Left" Visibility="Collapsed">
                                <ComboBoxItem Content="Sprite" Tag="Sprite"/>
                                <ComboBoxItem Content="Texture" Tag="Texture"/>
                                <ComboBoxItem Content="UI Icon" Tag="UIIcon"/>
                                <ComboBoxItem Content="Tilemap" Tag="Tilemap"/>
                            </ComboBox>
                            <TextBlock Text="TEMPLATE" Foreground="{StaticResource TextMuted}" FontWeight="Bold"
                                       FontSize="9" FontFamily="Segoe UI" VerticalAlignment="Center"
                                       Margin="20,0,6,0"/>
                            <ComboBox x:Name="TemplateCombo"
                                      FontSize="11" Padding="6,3" MinWidth="170"
                                      HorizontalAlignment="Left"
                                      SelectionChanged="TemplateCombo_Changed">
                                <ComboBoxItem Content="(No Template)" Tag="" IsSelected="True"/>
                            </ComboBox>
                            <Button Content="Save Template" Click="SaveAsTemplate_Click"
                                    Style="{StaticResource GhostBtn}" Foreground="{StaticResource TextMuted}"
                                    FontSize="9" FontFamily="Segoe UI" Padding="6,2"
                                    VerticalAlignment="Center" Margin="8,0,0,0"
                                    ToolTip="Save current toggle states as a reusable template"/>
                            <Button Content="Clear" Click="ClearPrompt_Click"
                                    Style="{StaticResource GhostBtn}" Foreground="{StaticResource TextMuted}"
                                    FontSize="10" FontFamily="Segoe UI" Padding="6,2"
                                    HorizontalAlignment="Right" VerticalAlignment="Center"
                                    ToolTip="Clear prompt text"/>
                        </DockPanel>
                        <!-- Active project name removed from here; shown next to Execute button -->
                        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" Margin="0,3,0,0">
                            <TextBlock x:Name="ImageIndicator" Foreground="{StaticResource Accent}" FontSize="11"
                                       FontFamily="Segoe UI" VerticalAlignment="Center" Visibility="Collapsed"/>
                            <Button x:Name="ClearImagesBtn" Content="Clear" Click="ClearImages_Click"
                                    Style="{StaticResource GhostBtn}" Foreground="{StaticResource Danger}"
                                    Margin="6,0,0,0" Visibility="Collapsed"/>
                        </StackPanel>
                        <!-- Dependency drop zone -->
                        <Border x:Name="DependencyDropZone" DockPanel.Dock="Bottom"
                                Background="#1A1A1A" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                CornerRadius="4" MinHeight="28" Margin="0,3,0,0" Padding="6,4"
                                AllowDrop="True"
                                PreviewDragOver="DependencyZone_DragOver"
                                Drop="DependencyZone_Drop">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Left" Text="DEPS" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="9" FontFamily="Segoe UI" VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <TextBlock x:Name="DependencyPlaceholder" Text="Drag tasks here to add dependencies..."
                                           Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI"
                                           VerticalAlignment="Center"/>
                                <ItemsControl x:Name="DependencyChips" Visibility="Collapsed">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </DockPanel>
                        </Border>
                        <!-- Additional instructions (saved with templates) -->
                        <DockPanel DockPanel.Dock="Bottom" Margin="0,3,0,0">
                            <TextBlock DockPanel.Dock="Top" Text="ADDITIONAL INSTRUCTIONS" Foreground="{StaticResource TextMuted}"
                                       FontWeight="Bold" FontSize="9" FontFamily="Segoe UI" Margin="0,0,0,2"/>
                            <TextBox x:Name="AdditionalInstructionsInput" AcceptsReturn="True" TextWrapping="Wrap"
                                     MinHeight="36" MaxHeight="100"
                                     VerticalScrollBarVisibility="Auto"
                                     Background="{StaticResource BgDeep}" Foreground="{StaticResource TextPrimary}"
                                     CaretBrush="{StaticResource TextPrimary}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                     FontSize="12" FontFamily="Consolas" Padding="6"
                                     ToolTip="Additional instructions saved with templates (e.g. coding standards, constraints)"/>
                        </DockPanel>
                        <!-- Divider between additional instructions and prompt -->
                        <Border DockPanel.Dock="Bottom" Margin="0,3,0,3" Height="1"
                                Background="{StaticResource BorderSubtle}" Opacity="0.4"/>
                        <TextBox x:Name="TaskInput" AcceptsReturn="True" TextWrapping="Wrap"
                                 MinHeight="50" MaxHeight="120"
                                 VerticalScrollBarVisibility="Auto"
                                 Background="{StaticResource BgDeep}" Foreground="{StaticResource TextPrimary}"
                                 CaretBrush="{StaticResource TextPrimary}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                 FontSize="13" FontFamily="Consolas" Padding="6"
                                 PreviewKeyDown="TaskInput_PreviewKeyDown"
                                 AllowDrop="True" PreviewDragOver="TaskInput_DragOver"
                                 Drop="TaskInput_Drop"/>
                    </DockPanel>
                </DockPanel>

                    <!-- Advanced side panel (Column 0, collapsible) -->
                    <Border x:Name="AdvancedSidePanel" Grid.Column="0" Visibility="Collapsed"
                            Background="{StaticResource BgSurface}" CornerRadius="6"
                            BorderBrush="{StaticResource BgElevated}" BorderThickness="1"
                            Margin="0,0,10,0" Padding="10" Width="200">
                        <DockPanel>
                            <DockPanel DockPanel.Dock="Top" Margin="0,0,0,8">
                                <TextBlock Text="ADVANCED" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                <Button Content="&#xE711;" Click="AdvancedToggle_Click"
                                        FontFamily="Segoe MDL2 Assets" FontSize="10"
                                        Style="{StaticResource IconBtn}" Foreground="{StaticResource TextMuted}"
                                        HorizontalAlignment="Right" Padding="2" ToolTip="Close" Cursor="Hand"/>
                            </DockPanel>
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel>
                                    <!-- Permanent toggles -->
                                    <TextBlock Text="PERSISTENT" Foreground="{StaticResource TextDisabled}" FontSize="9"
                                               FontFamily="Segoe UI" FontWeight="Bold" Margin="0,0,0,4"/>
                                    <ToggleButton x:Name="IgnoreFileLocksToggle" IsChecked="True"
                                                  Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6">
                                        <TextBlock Text="Ignore File Locks" Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                    <ToggleButton x:Name="UseMcpToggle" IsChecked="False"
                                                  Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6">
                                        <TextBlock Text="Use MCP" Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                    <!-- Separator -->
                                    <Border BorderBrush="{StaticResource SeparatorDark}" BorderThickness="0,1,0,0" Margin="0,4,0,8"/>
                                    <!-- Per-task toggles -->
                                    <TextBlock Text="PER-TASK" Foreground="{StaticResource TextDisabled}" FontSize="9"
                                               FontFamily="Segoe UI" FontWeight="Bold" Margin="0,0,0,4"/>
                                    <ToggleButton x:Name="RemoteSessionToggle" IsChecked="False"
                                                  Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6">
                                        <TextBlock Text="Remote Session" Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                    <ToggleButton x:Name="SpawnTeamToggle" IsChecked="False"
                                                  Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6">
                                        <TextBlock Text="Spawn Team" Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                    <ToggleButton x:Name="OvernightToggle" IsChecked="False"
                                                  Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6"
                                                  Checked="OvernightToggle_Changed" Unchecked="OvernightToggle_Changed">
                                        <TextBlock Text="Overnight Task" Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                    <ToggleButton x:Name="ExtendedPlanningToggle" IsChecked="False"
                                                  Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6">
                                        <TextBlock Text="Extended Planning" Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                    <ToggleButton x:Name="PlanOnlyToggle" IsChecked="False"
                                                  Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6"
                                                  Checked="PlanOnlyToggle_Changed" Unchecked="PlanOnlyToggle_Changed">
                                        <TextBlock Text="Plan Only" Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                    <ToggleButton x:Name="AutoDecomposeToggle" IsChecked="False"
                                                  Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6">
                                        <TextBlock Text="Auto-Decompose" Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </StackPanel>
                            </ScrollViewer>
                        </DockPanel>
                    </Border>
                </Grid>

                    <!-- Center-right: Saved Prompts panel -->
                    <Border Grid.Column="1" Background="{StaticResource BgSurface}" CornerRadius="6"
                            BorderBrush="{StaticResource BgElevated}" BorderThickness="1" Margin="10,0,0,0"
                            Padding="8">
                        <DockPanel>
                            <TextBlock DockPanel.Dock="Top" Text="SAVED" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                       FontSize="10" FontFamily="Segoe UI" Margin="0,0,0,6"/>
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="SavedPromptsPanel"
                                              ItemTemplate="{StaticResource SavedPromptTemplate}"/>
                            </ScrollViewer>
                        </DockPanel>
                    </Border>
                </Grid>
            </Border>

        <!-- Horizontal Splitter: Top ↔ Middle (Thumb-based to avoid GridSplitter star-sizing jitter) -->
        <Thumb x:Name="TopMiddleSplitter" Grid.Row="1" Grid.ColumnSpan="7"
               Style="{StaticResource HorizontalSplitterThumb}"
               DragStarted="TopMiddleSplitter_DragStarted"
               DragDelta="TopMiddleSplitter_DragDelta"
               DragCompleted="TopMiddleSplitter_DragCompleted"/>

        <!-- ═══ TASK LIST (3) ═══ -->
        <Border Grid.Row="0" Grid.Column="0" Background="{StaticResource BgSurface}" CornerRadius="8" Padding="10"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="SidebarBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="SidebarBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="SidebarBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <DockPanel Grid.Row="0" Margin="4,2,4,6">
                        <TextBlock Text="TASK LIST" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                   FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                    </DockPanel>
                <TabControl Grid.Row="1" Background="Transparent" BorderThickness="0"
                           SelectionChanged="TaskListTab_SelectionChanged">
                    <TabItem>
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ACTIVE" FontWeight="Bold" FontSize="11" FontFamily="Segoe UI"/>
                                <TextBlock x:Name="ActiveTabCount" FontWeight="Bold" FontSize="11"
                                           FontFamily="Segoe UI" Foreground="{StaticResource TextSubdued}"/>
                            </StackPanel>
                        </TabItem.Header>
                        <Grid Margin="0,6,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <DockPanel Grid.Row="0" Margin="4,0,0,8">
                                <Button Content="Clear" Click="ClearFinished_Click"
                                        Style="{StaticResource GhostBtn}" DockPanel.Dock="Right"/>
                                <StackPanel Orientation="Horizontal">
                                    <ComboBox x:Name="ActiveFilterCombo" SelectionChanged="ActiveFilter_Changed"
                                              FontSize="10" Padding="6,3"
                                              HorizontalAlignment="Left"/>
                                    <ComboBox x:Name="ActiveStatusFilterCombo" SelectionChanged="ActiveStatusFilter_Changed"
                                              FontSize="10" Padding="6,3" Margin="4,0,0,0"
                                              HorizontalAlignment="Left"/>
                                </StackPanel>
                            </DockPanel>
                            <Grid Grid.Row="1" Margin="4,0,4,6">
                                <TextBox x:Name="ActiveSearchBox"
                                         FontSize="12" Padding="6,4"
                                         Background="{StaticResource BgElevated}"
                                         Foreground="{StaticResource TextPrimary}"
                                         BorderThickness="1"
                                         TextChanged="ActiveSearchBox_TextChanged"/>
                                <TextBlock Text="Search tasks..." IsHitTestVisible="False"
                                           FontSize="12" Padding="8,5"
                                           Foreground="{StaticResource TextSubdued}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Text, ElementName=ActiveSearchBox}" Value="">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                            <ListBox x:Name="ActiveTasksList" Grid.Row="2"
                                     Style="{StaticResource TaskListStyle}"
                                     ItemTemplate="{StaticResource ActiveTaskTemplate}"
                                     SelectionChanged="ActiveTask_Selected"
                                     MouseDoubleClick="ActiveTaskList_MouseDoubleClick"
                                     PreviewMouseWheel="TaskList_PreviewMouseWheel"/>
                        </Grid>
                    </TabItem>
                    <TabItem>
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="HISTORY" FontWeight="Bold" FontSize="11" FontFamily="Segoe UI"/>
                                <TextBlock x:Name="HistoryTabCount" FontWeight="Bold" FontSize="11"
                                           FontFamily="Segoe UI" Foreground="{StaticResource TextSubdued}"/>
                            </StackPanel>
                        </TabItem.Header>
                        <Grid Margin="0,6,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <DockPanel Grid.Row="0" Margin="4,0,0,8">
                                <Button Content="Clear" Click="ClearHistory_Click"
                                        Style="{StaticResource GhostBtn}" DockPanel.Dock="Right"/>
                                <StackPanel Orientation="Horizontal">
                                    <ComboBox x:Name="HistoryFilterCombo" SelectionChanged="HistoryFilter_Changed"
                                              FontSize="10" Padding="6,3" Margin="0,0,4,0"
                                              HorizontalAlignment="Left"/>
                                    <ComboBox x:Name="HistoryStatusFilterCombo" SelectionChanged="HistoryStatusFilter_Changed"
                                              FontSize="10" Padding="6,3" Margin="0,0,4,0"
                                              HorizontalAlignment="Left"/>
                                    <ComboBox x:Name="HistoryGroupFilterCombo" SelectionChanged="HistoryGroupFilter_Changed"
                                              FontSize="10" Padding="6,3"
                                              HorizontalAlignment="Left"/>
                                </StackPanel>
                            </DockPanel>
                            <Grid Grid.Row="1" Margin="4,0,4,6">
                                <TextBox x:Name="HistorySearchBox"
                                         FontSize="12" Padding="6,4"
                                         Background="{StaticResource BgElevated}"
                                         Foreground="{StaticResource TextPrimary}"
                                         BorderThickness="1"
                                         TextChanged="HistorySearchBox_TextChanged"/>
                                <TextBlock Text="Search tasks..." IsHitTestVisible="False"
                                           FontSize="12" Padding="8,5"
                                           Foreground="{StaticResource TextSubdued}">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Text, ElementName=HistorySearchBox}" Value="">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                            <ListBox x:Name="HistoryTasksList" Grid.Row="2"
                                     Style="{StaticResource TaskListStyle}"
                                     ItemTemplate="{StaticResource HistoryTaskTemplate}"
                                     SelectionChanged="HistoryTask_Selected"
                                     PreviewMouseWheel="TaskList_PreviewMouseWheel"/>
                        </Grid>
                    </TabItem>
                    <TabItem x:Name="StoredTabItem">
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="STORED" FontWeight="Bold" FontSize="11" FontFamily="Segoe UI"/>
                                <TextBlock x:Name="StoredTabBadge" FontWeight="Bold" FontSize="11"
                                           FontFamily="Segoe UI" Foreground="{StaticResource TextSubdued}" Visibility="Collapsed"/>
                            </StackPanel>
                        </TabItem.Header>
                        <Grid Margin="0,6,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <DockPanel Grid.Row="0" Margin="4,0,0,8">
                                <Button Content="Clear" Click="ClearStoredTasks_Click"
                                        Style="{StaticResource GhostBtn}" DockPanel.Dock="Right"/>
                                <ComboBox x:Name="StoredFilterCombo" SelectionChanged="StoredFilter_Changed"
                                          FontSize="10" Padding="6,3"
                                          HorizontalAlignment="Left"/>
                            </DockPanel>
                            <ListBox x:Name="StoredTasksList" Grid.Row="1"
                                     Style="{StaticResource TaskListStyle}"
                                     ItemTemplate="{StaticResource StoredTaskTemplate}"
                                     PreviewMouseWheel="TaskList_PreviewMouseWheel"/>
                        </Grid>
                    </TabItem>
                </TabControl>
                </Grid>
            </Border>

        <!-- ═══ GRAPH + TASK OUTPUT (4) ═══ -->
        <Grid Grid.Row="0" Grid.Column="2">
            <Grid.RowDefinitions>
                <RowDefinition x:Name="GraphPanelRow" Height="180" MinHeight="60"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*" MinHeight="120"/>
            </Grid.RowDefinitions>

            <!-- Node Graph Panel -->
            <controls:TaskNodeGraphPanel x:Name="NodeGraphPanel" Grid.Row="0"/>

            <!-- Splitter between graph and output -->
            <GridSplitter Grid.Row="1" Height="6" HorizontalAlignment="Stretch"
                          VerticalAlignment="Center" Background="Transparent"
                          Style="{StaticResource HorizontalSplitter}"/>

            <!-- Task Output -->
            <Border Grid.Row="2" Background="{StaticResource BgSurface}" CornerRadius="8" Padding="4"
                    BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="MainContentBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="MainContentBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="MainContentBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="TASK OUTPUT" Foreground="{StaticResource Accent}" FontWeight="Bold"
                               FontSize="10" FontFamily="Segoe UI" Margin="8,6,0,4"/>
                    <TabControl x:Name="OutputTabs" Style="{StaticResource OutputTabControlStyle}"
                                SizeChanged="OutputTabs_SizeChanged"/>
                </DockPanel>
            </Border>
        </Grid>

        <!-- ═══ CHAT PANEL ═══ -->
        <Thumb x:Name="ChatSplitter" Grid.Column="3" Grid.Row="0" Grid.RowSpan="5"
               Style="{StaticResource VerticalSplitterThumb}"
               DragDelta="ChatSplitter_DragDelta" Visibility="Collapsed"/>

        <Grid Grid.Column="6" Grid.Row="2" Grid.RowSpan="3">
            <!-- Chat panel -->
            <Border x:Name="ChatExpandedPanel" Background="{StaticResource BgSurface}" CornerRadius="8"
                    BorderBrush="{StaticResource BgElevated}" BorderThickness="1" Padding="8">
                <DockPanel>
                    <!-- Header with New Chat button -->
                    <DockPanel DockPanel.Dock="Top" Margin="0,0,0,6">
                        <TextBlock Text="CHAT" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                   FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                        <Button x:Name="NewChatBtn" Content="New Chat" Click="NewChat_Click"
                                Style="{StaticResource GhostBtn}" Foreground="{StaticResource Accent}"
                                HorizontalAlignment="Right" FontSize="10"/>
                    </DockPanel>
                    <!-- Image preview strip above input -->
                    <WrapPanel x:Name="ChatImagePreview" DockPanel.Dock="Bottom" Margin="0,4,0,0"
                               Visibility="Collapsed"/>
                    <!-- Input area at the bottom -->
                    <DockPanel DockPanel.Dock="Bottom" Margin="0,6,0,0">
                        <Button x:Name="ChatSendBtn" Content="&#xE724;" Click="ChatSend_Click"
                                DockPanel.Dock="Right" Margin="4,0,0,0" VerticalAlignment="Center"
                                Padding="6,6" FontSize="13" ToolTip="Send message">
                            <Button.Style>
                                <Style TargetType="Button">
                                    <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
                                    <Setter Property="Foreground" Value="White"/>
                                    <Setter Property="Cursor" Value="Hand"/>
                                    <Setter Property="BorderThickness" Value="0"/>
                                    <Setter Property="Template">
                                        <Setter.Value>
                                            <ControlTemplate TargetType="Button">
                                                <Border x:Name="Bd" Background="{StaticResource Accent}" CornerRadius="6"
                                                        Padding="{TemplateBinding Padding}" SnapsToDevicePixels="True">
                                                    <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                                <ControlTemplate.Triggers>
                                                    <Trigger Property="IsMouseOver" Value="True">
                                                        <Setter TargetName="Bd" Property="Background" Value="{StaticResource AccentHover}"/>
                                                    </Trigger>
                                                    <Trigger Property="IsPressed" Value="True">
                                                        <Setter TargetName="Bd" Property="Opacity" Value="0.85"/>
                                                    </Trigger>
                                                </ControlTemplate.Triggers>
                                            </ControlTemplate>
                                        </Setter.Value>
                                    </Setter>
                                </Style>
                            </Button.Style>
                        </Button>
                        <TextBox x:Name="ChatInput" AcceptsReturn="True" TextWrapping="Wrap"
                                 MaxHeight="60" MinHeight="28"
                                 VerticalScrollBarVisibility="Auto"
                                 AllowDrop="True"
                                 PreviewDragOver="ChatInput_DragOver"
                                 Drop="ChatInput_Drop"
                                 Background="{StaticResource BgDeep}" Foreground="{StaticResource TextPrimary}"
                                 CaretBrush="{StaticResource TextPrimary}" BorderBrush="{StaticResource BorderSubtle}"
                                 BorderThickness="1" FontSize="12" FontFamily="Segoe UI" Padding="6,4"
                                 PreviewKeyDown="ChatInput_PreviewKeyDown"
                                 VerticalContentAlignment="Center"/>
                    </DockPanel>
                    <!-- Chat messages -->
                    <ScrollViewer x:Name="ChatScrollViewer" VerticalScrollBarVisibility="Auto"
                                    HorizontalScrollBarVisibility="Disabled">
                        <StackPanel x:Name="ChatMessagesPanel"/>
                    </ScrollViewer>
                </DockPanel>
            </Border>
        </Grid>

        <!-- Vertical Splitter: Center ↔ Right (Thumb-based to avoid GridSplitter col-4 mis-targeting) -->
        <Thumb x:Name="RightSplitter" Grid.Column="5" Grid.Row="0" Grid.RowSpan="5"
               Style="{StaticResource VerticalSplitterThumb}"
               DragDelta="RightSplitter_DragDelta"/>

        <!-- ═══ SETTINGS (5) ═══ -->
        <!-- Collapsed strip (shown when panel is collapsed) -->
        <Border x:Name="SettingsCollapsedStrip" Grid.Row="0" Grid.Column="6"
                Background="{StaticResource BgSurface}" CornerRadius="8" Padding="0" Visibility="Collapsed"
                BorderThickness="1" BorderBrush="{StaticResource BgElevated}" Width="32">
            <Button x:Name="ExpandSettingsBtn" Click="ToggleSettingsPanel_Click"
                    ToolTip="Expand Settings" VerticalAlignment="Top" HorizontalAlignment="Center"
                    Margin="0,6,0,0">
                <Button.Style>
                    <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                        <Setter Property="Content" Value="&#xE76B;"/>
                        <Setter Property="FontSize" Value="12"/>
                        <Setter Property="Foreground" Value="{StaticResource Accent}"/>
                    </Style>
                </Button.Style>
            </Button>
        </Border>
        <!-- Expanded settings panel -->
        <Border x:Name="SettingsExpandedPanel" Grid.Row="0" Grid.Column="6" Background="{StaticResource BgSurface}" CornerRadius="8" Padding="4"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="RightPanelBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="RightPanelBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="RightPanelBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <DockPanel>
                    <DockPanel DockPanel.Dock="Top" Margin="8,6,4,4">
                        <TextBlock Text="SETTINGS" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                   FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                        <Button Click="ToggleSettingsPanel_Click" ToolTip="Collapse Settings"
                                HorizontalAlignment="Right">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE76C;"/>
                                    <Setter Property="FontSize" Value="12"/>
                                    <Setter Property="Foreground" Value="{StaticResource TextMuted}"/>
                                </Style>
                            </Button.Style>
                        </Button>
                    </DockPanel>
                <TabControl x:Name="MainTabs" Style="{StaticResource SettingsTabControlStyle}"
                            Background="Transparent" BorderThickness="0">
                    <!-- Automation tab -->
                    <TabItem x:Name="HelperTabItem">
                        <TabItem.Header>
                            <TextBlock Text="Automation" Foreground="{StaticResource TextTabHeader}" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <DockPanel Margin="12">
                            <!-- Top controls -->
                            <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                                <TextBlock Text="Project Suggestions" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,6"/>
                                <TextBlock Text="Analyze the current project and generate actionable suggestions for improvements."
                                           Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,0,0,12"/>

                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Category" Foreground="{StaticResource TextLight}" FontSize="12"
                                               FontFamily="Segoe UI" VerticalAlignment="Center"
                                               Margin="0,0,10,0"/>
                                    <ComboBox x:Name="HelperCategoryCombo" Width="160"
                                              FontSize="11" Padding="6,3" HorizontalAlignment="Left">
                                        <ComboBoxItem Content="General" Tag="General" IsSelected="True"/>
                                        <ComboBoxItem Content="Bug Fixes" Tag="BugFixes"/>
                                        <ComboBoxItem Content="New Features" Tag="NewFeatures"/>
                                        <ComboBoxItem Content="Extensions" Tag="Extensions"/>
                                        <ComboBoxItem Content="Rules" Tag="Rules"/>
                                    </ComboBox>
                                </DockPanel>

                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Guidance" Foreground="{StaticResource TextLight}" FontSize="12"
                                               FontFamily="Segoe UI" VerticalAlignment="Center"
                                               Margin="0,0,10,0"/>
                                    <Grid>
                                        <TextBox x:Name="SuggestionGuidanceInput"
                                                 FontSize="11" FontFamily="Segoe UI" Padding="6,4"
                                                 Background="{StaticResource BgSection}" Foreground="{StaticResource TextLight}"
                                                 BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                                 VerticalAlignment="Center"
                                                 PreviewKeyDown="SuggestionGuidanceInput_PreviewKeyDown"/>
                                        <TextBlock Text="Optional: guide the suggestions (e.g. &quot;focus on error handling&quot;)"
                                                   Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI"
                                                   Padding="8,5" IsHitTestVisible="False" VerticalAlignment="Center">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Text, ElementName=SuggestionGuidanceInput}" Value="">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </DockPanel>

                                <StackPanel Orientation="Horizontal">
                                    <Button x:Name="GenerateSuggestionsBtn" Content="Generate Suggestions"
                                            Click="GenerateSuggestions_Click"
                                            Background="{StaticResource Accent}" Style="{StaticResource Btn}"
                                            FontSize="12" Padding="16,8"/>
                                    <Button x:Name="ClearSuggestionsBtn" Content="Clear All"
                                            Click="ClearSuggestions_Click"
                                            Style="{StaticResource GhostBtn}"
                                            FontSize="11" Padding="12,6" Margin="8,0,0,0"/>
                                    <TextBlock x:Name="HelperStatusText" Text=""
                                               Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center" Margin="12,0,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <Border DockPanel.Dock="Top" Height="1" Background="{StaticResource BgElevated}" Margin="0,0,0,8"/>

                            <!-- Error section -->
                            <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                                <TextBlock Text="Error" Foreground="{StaticResource DangerBright}" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,6"/>
                                <TextBlock Text="Investigate project crash logs and diagnose build failures."
                                           Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,0,0,8"/>
                                <Button x:Name="BuildInvestigationBtn" Content="Build Investigation"
                                        Click="BuildInvestigation_Click"
                                        Background="#3A2020" Foreground="{StaticResource DangerBright}"
                                        Style="{StaticResource Btn}"
                                        FontSize="12" Padding="16,8" HorizontalAlignment="Left"/>
                            </StackPanel>

                            <Border DockPanel.Dock="Top" Height="1" Background="{StaticResource BgElevated}" Margin="0,0,0,8"/>

                            <!-- Suggestions list -->
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="SuggestionsListView">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="6" Padding="12,10" Margin="0,3"
                                                    Background="{StaticResource BgSection}" BorderThickness="1" BorderBrush="{StaticResource BgElevated}">
                                                <Border.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="Copy" Tag="{Binding}"
                                                                  Click="CopySuggestion_Click"/>
                                                    </ContextMenu>
                                                </Border.ContextMenu>
                                                <DockPanel>
                                                    <StackPanel DockPanel.Dock="Right" VerticalAlignment="Center"
                                                                Margin="10,0,0,0">
                                                        <Button Content="Run" Tag="{Binding}"
                                                                Click="RunSuggestion_Click"
                                                                Background="{StaticResource Accent}" Style="{StaticResource Btn}"
                                                                FontSize="11" Padding="14,5" Margin="0,0,0,4"/>
                                                        <Button Content="Save" Tag="{Binding}"
                                                                Click="SaveSuggestion_Click"
                                                                Style="{StaticResource GhostBtn}"
                                                                FontSize="10" Padding="10,3" Margin="0,0,0,4"/>
                                                        <Button Content="Remove" Tag="{Binding}"
                                                                Click="RemoveSuggestion_Click"
                                                                Style="{StaticResource GhostBtn}"
                                                                FontSize="10" Padding="10,3" Margin="0,0,0,4"/>
                                                        <Button Content="Ignore" Tag="{Binding}"
                                                                Click="IgnoreSuggestion_Click"
                                                                Style="{StaticResource GhostBtn}"
                                                                FontSize="10" Padding="10,3"/>
                                                    </StackPanel>
                                                    <StackPanel>
                                                        <DockPanel Margin="0,0,0,4">
                                                            <Border CornerRadius="3" Padding="6,2" Margin="0,0,8,0"
                                                                    VerticalAlignment="Center">
                                                                <Border.Style>
                                                                    <Style TargetType="Border">
                                                                        <Setter Property="Background" Value="{StaticResource BorderSubtle}"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Category}" Value="BugFixes">
                                                                                <Setter Property="Background" Value="#3A2020"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding Category}" Value="NewFeatures">
                                                                                <Setter Property="Background" Value="#1A3A20"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding Category}" Value="Extensions">
                                                                                <Setter Property="Background" Value="#1A2040"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding Category}" Value="Rules">
                                                                                <Setter Property="Background" Value="#2A2A1A"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Border.Style>
                                                                <TextBlock FontSize="10" FontFamily="Segoe UI"
                                                                           FontWeight="SemiBold">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Text" Value="{Binding Category}"/>
                                                                            <Setter Property="Foreground" Value="{StaticResource TextSecondary}"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding Category}" Value="BugFixes">
                                                                                    <Setter Property="Foreground" Value="{StaticResource DangerBright}"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding Category}" Value="NewFeatures">
                                                                                    <Setter Property="Foreground" Value="#4EC969"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding Category}" Value="Extensions">
                                                                                    <Setter Property="Foreground" Value="{StaticResource PausedBlue}"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding Category}" Value="Rules">
                                                                                    <Setter Property="Foreground" Value="#D4C44D"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                            </Border>
                                                            <TextBlock Text="{Binding Title}" Foreground="#DDD"
                                                                       FontSize="13" FontWeight="SemiBold"
                                                                       FontFamily="Segoe UI"
                                                                       TextTrimming="CharacterEllipsis"/>
                                                        </DockPanel>
                                                        <TextBlock Text="{Binding Description}" Foreground="{StaticResource TextSecondary}"
                                                                   FontSize="11" FontFamily="Segoe UI"
                                                                   TextWrapping="Wrap"/>
                                                    </StackPanel>
                                                </DockPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </DockPanel>
                    </TabItem>
                    <!-- File Locks tab -->
                    <TabItem x:Name="FileLocksTabHeader">
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="File Locks" Foreground="{StaticResource TextTabHeader}" FontFamily="Segoe UI" FontSize="12"/>
                                <TextBlock x:Name="FileLockBadge" Text="0" Visibility="Collapsed"
                                           Foreground="{StaticResource WarningOrange}" FontSize="10" FontWeight="Bold"
                                           FontFamily="Segoe UI" Margin="4,0,0,0"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </TabItem.Header>
                        <DockPanel Margin="8">
                            <TextBlock DockPanel.Dock="Top" Text="Active file locks across all tasks"
                                       Foreground="{StaticResource TextMuted}" FontSize="11" FontFamily="Segoe UI"
                                       Margin="4,6,4,8"/>
                            <!-- Header row -->
                            <Grid DockPanel.Dock="Top" Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="90"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="FILE" Foreground="{StaticResource TextMuted}" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="1" Text="STATUS" Foreground="{StaticResource TextMuted}" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="2" Text="TOOL" Foreground="{StaticResource TextMuted}" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="3" Text="PATH" Foreground="{StaticResource TextMuted}" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="4" Text="TASK" Foreground="{StaticResource TextMuted}" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="5" Text="SINCE" Foreground="{StaticResource TextMuted}" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                            </Grid>
                            <Border DockPanel.Dock="Top" Height="1" Background="{StaticResource BgElevated}" Margin="0,0,0,4"/>
                            <!-- Lock rows -->
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="FileLocksListView">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="8,5" Margin="0,1" CornerRadius="4"
                                                    Background="{StaticResource BgSection}">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="160"/>
                                                        <ColumnDefinition Width="70"/>
                                                        <ColumnDefinition Width="90"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="70"/>
                                                        <ColumnDefinition Width="70"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding FileName}"
                                                               Foreground="{StaticResource TextLight}" FontSize="11" FontFamily="Consolas"
                                                               TextTrimming="CharacterEllipsis"
                                                               ToolTip="{Binding OriginalPath}"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding StatusText}"
                                                               FontSize="11" FontFamily="Consolas">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="#4EC969"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsIgnored}" Value="True">
                                                                        <Setter Property="Foreground" Value="{StaticResource WarningOrange}"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                    <TextBlock Grid.Column="2" Text="{Binding ToolName}"
                                                               Foreground="{StaticResource TextSecondary}" FontSize="11" FontFamily="Consolas"/>
                                                    <TextBlock Grid.Column="3" Text="{Binding OriginalPath}"
                                                               Foreground="{StaticResource TextDim}" FontSize="11" FontFamily="Consolas"
                                                               TextTrimming="CharacterEllipsis" Margin="8,0,0,0"/>
                                                    <TextBlock Grid.Column="4" Text="{Binding OwnerTaskId, StringFormat='#{0}'}"
                                                               Foreground="{StaticResource Accent}" FontSize="11" FontFamily="Consolas"/>
                                                    <TextBlock Grid.Column="5" Text="{Binding TimeText}"
                                                               Foreground="{StaticResource TextMuted}" FontSize="11" FontFamily="Consolas"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </DockPanel>
                    </TabItem>
                    <!-- Activity tab -->
                    <TabItem x:Name="ActivityTabItem">
                        <TabItem.Header>
                            <TextBlock Text="Activity" Foreground="#AAA" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <ScrollViewer x:Name="ActivityTabContent" VerticalScrollBarVisibility="Auto" Padding="12"/>
                    </TabItem>
                    <!-- Advanced tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock Text="Advanced" Foreground="{StaticResource TextTabHeader}" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel MaxWidth="600">
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="System Prompt" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditSystemPromptToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditSystemPromptToggle_Changed"
                                                  Unchecked="EditSystemPromptToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <TextBox x:Name="SystemPromptBox" AcceptsReturn="True" TextWrapping="Wrap"
                                         MinHeight="160" MaxHeight="300"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                         CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="10"
                                         IsReadOnly="True" Opacity="0.6"/>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="This prompt is prepended to every task. MCP instructions are added automatically when the MCP toggle is enabled."
                                               Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="PromptEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button x:Name="ResetPromptBtn" Content="Reset" Click="ResetPrompt_Click"
                                                Style="{StaticResource GhostBtn}" Margin="0,0,6,0"
                                                Padding="12,4" FontSize="11"/>
                                        <Button x:Name="SavePromptBtn" Content="Save" Click="SavePrompt_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>

                                <!-- Short Description -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Short Description" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditShortDescToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditShortDescToggle_Changed"
                                                  Unchecked="EditShortDescToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <TextBox x:Name="ShortDescBox" AcceptsReturn="True" TextWrapping="Wrap"
                                         MinHeight="60" MaxHeight="160"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                         CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="10"
                                         IsReadOnly="True" Opacity="0.6"/>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="A brief summary of the active project, sent with each task."
                                               Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="ShortDescEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button Content="Save" Click="SaveShortDesc_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>

                                <!-- Long Description -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Long Description" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditLongDescToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditLongDescToggle_Changed"
                                                  Unchecked="EditLongDescToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <TextBox x:Name="LongDescBox" AcceptsReturn="True" TextWrapping="Wrap"
                                         MinHeight="120" MaxHeight="300"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                         CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="10"
                                         IsReadOnly="True" Opacity="0.6"/>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="Detailed project description used when Extended Planning is enabled."
                                               Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="LongDescEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button Content="Save" Click="SaveLongDesc_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <Button x:Name="RegenerateDescBtn" Content="Regenerate Descriptions"
                                        Click="RegenerateDescriptions_Click"
                                        Background="{StaticResource Accent}" Style="{StaticResource Btn}"
                                        FontSize="12" Padding="16,8" Margin="0,16,0,0"
                                        HorizontalAlignment="Left"/>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>

                                <!-- Rule Instruction -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Rule Instruction" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditRuleInstructionToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditRuleInstructionToggle_Changed"
                                                  Unchecked="EditRuleInstructionToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <TextBox x:Name="RuleInstructionBox" AcceptsReturn="True" TextWrapping="Wrap"
                                         MinHeight="60" MaxHeight="160"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                         CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="10"
                                         IsReadOnly="True" Opacity="0.6"/>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="Project-specific rules passed with every prompt."
                                               Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="RuleInstructionEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button Content="Save" Click="SaveRuleInstruction_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <!-- Project Rules List -->
                                <TextBlock Text="Project Rules" Foreground="{StaticResource TextLight}" FontWeight="SemiBold"
                                           FontSize="12" FontFamily="Segoe UI" Margin="0,16,0,6"/>
                                <ItemsControl x:Name="ProjectRulesList">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="4" Padding="8,5" Margin="0,2"
                                                    Background="{StaticResource BgSection}" BorderThickness="1" BorderBrush="{StaticResource BgElevated}">
                                                <DockPanel>
                                                    <Button Content="&#xE711;" FontFamily="Segoe MDL2 Assets"
                                                            FontSize="9" Foreground="{StaticResource TextSubdued}" Background="Transparent"
                                                            BorderThickness="0" Cursor="Hand" Padding="4,2"
                                                            DockPanel.Dock="Right" VerticalAlignment="Center"
                                                            Tag="{Binding}" Click="RemoveProjectRule_Click"/>
                                                    <TextBlock Text="{Binding}" Foreground="{StaticResource TextLight}" FontSize="11"
                                                               FontFamily="Segoe UI" TextWrapping="Wrap"
                                                               VerticalAlignment="Center"/>
                                                </DockPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <DockPanel Margin="0,8,0,0">
                                    <Button Content="Add" Click="AddProjectRule_Click"
                                            Style="{StaticResource Btn}" DockPanel.Dock="Right"
                                            Background="{StaticResource Accent}" Padding="14,6" FontSize="11" Margin="6,0,0,0"/>
                                    <TextBox x:Name="NewRuleInput"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                             CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                             FontSize="12" FontFamily="Segoe UI" Padding="8,6"
                                             KeyDown="NewRuleInput_KeyDown"/>
                                </DockPanel>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>


                                <!-- Project Type -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Project Type" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                </DockPanel>
                                <ToggleButton x:Name="ProjectTypeGameToggle"
                                              Style="{StaticResource ToggleSwitch}" Margin="0,0,0,6"
                                              Checked="ProjectTypeGameToggle_Changed"
                                              Unchecked="ProjectTypeGameToggle_Changed">
                                    <TextBlock Text="Game project" Foreground="{StaticResource TextLight}"
                                               FontSize="12" FontFamily="Segoe UI"/>
                                </ToggleButton>
                                <TextBlock Text="When enabled, game creation rules are automatically included with every task."
                                           Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI" Margin="0,0,0,4"/>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>

                                <!-- Log Paths -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Log Paths" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditCrashLogPathsToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditCrashLogPathsToggle_Changed"
                                                  Unchecked="EditCrashLogPathsToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <StackPanel Margin="0,0,0,4">
                                    <TextBlock Text="Crash Log" Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" Margin="0,0,0,2"/>
                                    <TextBox x:Name="CrashLogPathBox"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                             CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                             FontSize="12" FontFamily="Consolas" Padding="10"
                                             IsReadOnly="True" Opacity="0.6"/>
                                </StackPanel>
                                <StackPanel Margin="0,0,0,4">
                                    <TextBlock Text="App Log" Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" Margin="0,0,0,2"/>
                                    <TextBox x:Name="AppLogPathBox"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                             CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                             FontSize="12" FontFamily="Consolas" Padding="10"
                                             IsReadOnly="True" Opacity="0.6"/>
                                </StackPanel>
                                <StackPanel Margin="0,0,0,4">
                                    <TextBlock Text="Hang Log" Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" Margin="0,0,0,2"/>
                                    <TextBox x:Name="HangLogPathBox"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                             CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                             FontSize="12" FontFamily="Consolas" Padding="10"
                                             IsReadOnly="True" Opacity="0.6"/>
                                </StackPanel>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="Used by Build Investigation to locate crash and error logs."
                                               Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="CrashLogPathsEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button Content="Reset" Click="ResetCrashLogPaths_Click"
                                                Style="{StaticResource GhostBtn}" Margin="0,0,6,0"
                                                Padding="12,4" FontSize="11"/>
                                        <Button Content="Save" Click="SaveCrashLogPaths_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>

                                <TextBlock Text="Defaults" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,12"/>
                                <ToggleButton x:Name="DefaultNoGitWriteToggle" IsChecked="True"
                                              Style="{StaticResource ToggleSwitch}" Margin="0,0,0,14">
                                    <TextBlock Text="No Git Write by default" Foreground="{StaticResource TextLight}"
                                               FontSize="12" FontFamily="Segoe UI"/>
                                </ToggleButton>

                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="Max concurrent tasks" Foreground="{StaticResource TextLight}"
                                               FontSize="12" FontFamily="Segoe UI" VerticalAlignment="Center"
                                               Margin="0,0,12,0"/>
                                    <TextBox x:Name="MaxConcurrentTasksBox" Width="60" Text="10"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                             CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                             FontSize="12" FontFamily="Segoe UI" Padding="6,4"
                                             TextAlignment="Center"
                                             LostFocus="MaxConcurrentTasks_Changed"
                                             KeyDown="MaxConcurrentTasks_KeyDown"/>
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="History retention" Foreground="{StaticResource TextLight}"
                                               FontSize="12" FontFamily="Segoe UI" VerticalAlignment="Center"
                                               Margin="0,0,12,0"/>
                                    <ComboBox x:Name="HistoryRetentionCombo" Width="120"
                                              SelectionChanged="HistoryRetention_Changed">
                                        <ComboBoxItem Content="6 hours" Tag="6"/>
                                        <ComboBoxItem Content="12 hours" Tag="12"/>
                                        <ComboBoxItem Content="24 hours" Tag="24" IsSelected="True"/>
                                        <ComboBoxItem Content="3 days" Tag="72"/>
                                        <ComboBoxItem Content="7 days" Tag="168"/>
                                    </ComboBox>
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="Token limit retry (min)" Foreground="{StaticResource TextLight}"
                                               FontSize="12" FontFamily="Segoe UI" VerticalAlignment="Center"
                                               Margin="0,0,12,0"/>
                                    <TextBox x:Name="TokenLimitRetryBox" Width="60" Text="30"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                             CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                             FontSize="12" FontFamily="Segoe UI" Padding="6,4"
                                             TextAlignment="Center"
                                             LostFocus="TokenLimitRetry_Changed"
                                             KeyDown="TokenLimitRetry_KeyDown"/>
                                </StackPanel>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,10,0,10"/>

                                <TextBlock Text="Diagnostics" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,8"/>
                                <Button x:Name="ViewLogsBtn" Content="View Application Log"
                                        Click="ViewLogs_Click"
                                        Style="{StaticResource SecondaryBtn}"
                                        HorizontalAlignment="Left"
                                        Padding="14,7" FontSize="12"/>
                                <Button Content="View Activity Dashboard"
                                        Click="ViewActivity_Click"
                                        Style="{StaticResource SecondaryBtn}"
                                        HorizontalAlignment="Left"
                                        Padding="14,7" FontSize="12" Margin="0,8,0,0"/>
                                <Button Content="Clear All Ignored Suggestions"
                                        Click="ClearIgnoredSuggestions_Click"
                                        Style="{StaticResource SecondaryBtn}"
                                        HorizontalAlignment="Left"
                                        Padding="14,7" FontSize="12" Margin="0,8,0,0"/>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,10,0,20"/>

                                <TextBlock Text="About" Foreground="{StaticResource TextMuted}" FontSize="11" FontFamily="Segoe UI"/>
                                <TextBlock Text="Happy Engine - Claude Code Task Manager" Foreground="{StaticResource TextDisabled}"
                                           FontSize="11" FontFamily="Segoe UI" Margin="0,4,0,0"/>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                    <!-- Gemini tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock Text="Gemini" Foreground="{StaticResource TextTabHeader}" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel MaxWidth="600">
                                <TextBlock Text="Gemini Image Generation" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,8"/>
                                <TextBlock Text="Configure Google Gemini API for AI image generation. When Gemini is selected as the model, prompts generate images instead of code."
                                           Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,0,0,16"/>

                                <TextBlock Text="API Key" Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <DockPanel Margin="0,0,0,4">
                                    <Button x:Name="SaveGeminiKeyBtn" Content="Save" Click="SaveGeminiKey_Click"
                                            Style="{StaticResource Btn}" DockPanel.Dock="Right"
                                            Background="{StaticResource Accent}" Padding="14,6" FontSize="11" Margin="6,0,0,0"/>
                                    <TextBox x:Name="GeminiApiKeyBox"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                             CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                             FontSize="12" FontFamily="Consolas" Padding="8,6"/>
                                </DockPanel>
                                <TextBlock x:Name="GeminiKeyStatus" Text="" Foreground="{StaticResource Success}" FontSize="11"
                                           FontFamily="Segoe UI" Margin="0,4,0,0"/>
                                <TextBlock Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI" Margin="0,8,0,0"
                                           TextWrapping="Wrap">
                                    Get a free API key from Google AI:
                                    <TextBlock.ToolTip>https://ai.google.dev/gemini-api/docs/api-key</TextBlock.ToolTip>
                                </TextBlock>
                                <TextBlock Text="https://ai.google.dev/gemini-api/docs/api-key" Foreground="{StaticResource Accent}"
                                           FontSize="11" FontFamily="Consolas" Margin="0,2,0,0"
                                           Cursor="Hand" MouseDown="GeminiApiLink_Click"
                                           TextDecorations="Underline"/>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>

                                <TextBlock Text="Model" Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <ComboBox x:Name="GeminiModelCombo"
                                          FontSize="11" Padding="6,3" MinWidth="280"
                                          HorizontalAlignment="Left" Margin="0,0,0,4"
                                          SelectionChanged="GeminiModelCombo_Changed"/>
                                <TextBlock Text="Supports native image generation with text prompts. Images are saved to AppData."
                                           Foreground="{StaticResource TextMuted}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"/>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>

                                <TextBlock Text="Image Storage" Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <TextBlock Text="%LOCALAPPDATA%\HappyEngine\gemini_images\" Foreground="{StaticResource TextSubdued}"
                                           FontSize="11" FontFamily="Consolas" Margin="0,0,0,6"/>
                                <Button x:Name="OpenGeminiImagesBtn" Content="Open Images Folder"
                                        Click="OpenGeminiImages_Click"
                                        Style="{StaticResource GhostBtn}" Foreground="{StaticResource Accent}"
                                        FontSize="11" HorizontalAlignment="Left"/>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                    <!-- Claude tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock Text="Claude" Foreground="{StaticResource TextTabHeader}" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel MaxWidth="600">
                                <TextBlock Text="Claude Chat API" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,8"/>
                                <TextBlock Text="Configure an Anthropic API key to use Claude models in the Chat panel."
                                           Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,0,0,16"/>

                                <TextBlock Text="API Key" Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <DockPanel Margin="0,0,0,4">
                                    <Button x:Name="SaveClaudeKeyBtn" Content="Save" Click="SaveClaudeKey_Click"
                                            Style="{StaticResource Btn}" DockPanel.Dock="Right"
                                            Background="{StaticResource Accent}" Padding="14,6" FontSize="11" Margin="6,0,0,0"/>
                                    <TextBox x:Name="ClaudeApiKeyBox"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                             CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                             FontSize="12" FontFamily="Consolas" Padding="8,6"/>
                                </DockPanel>
                                <TextBlock x:Name="ClaudeKeyStatus" Text="" Foreground="{StaticResource Success}" FontSize="11"
                                           FontFamily="Segoe UI" Margin="0,4,0,0"/>
                                <TextBlock Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI" Margin="0,8,0,0"
                                           TextWrapping="Wrap">
                                    Get an API key from Anthropic:
                                </TextBlock>
                                <TextBlock Text="https://console.anthropic.com/settings/keys" Foreground="{StaticResource Accent}"
                                           FontSize="11" FontFamily="Consolas" Margin="0,2,0,0"
                                           Cursor="Hand" MouseDown="ClaudeApiLink_Click"
                                           TextDecorations="Underline"/>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                    <!-- Chat tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock Text="Chat" Foreground="{StaticResource TextTabHeader}" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel MaxWidth="600">
                                <TextBlock Text="Chat Model" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,8"/>
                                <TextBlock Text="Select which AI model to use in the Chat panel."
                                           Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,0,0,16"/>

                                <TextBlock Text="Model" Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <ComboBox x:Name="ChatModelCombo"
                                          FontSize="11" Padding="6,3" MinWidth="280"
                                          HorizontalAlignment="Left" Margin="0,0,0,4"
                                          SelectionChanged="ChatModelCombo_Changed"/>
                                <TextBlock Text="Available models depend on which API keys are configured (Gemini and Claude tabs)."
                                           Foreground="{StaticResource TextMuted}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"/>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                    <!-- MCP tab -->
                    <TabItem x:Name="McpTabItem">
                        <TabItem.Header>
                            <TextBlock Text="MCP" Foreground="{StaticResource TextTabHeader}" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel MaxWidth="600">
                                <TextBlock Text="MCP Server Configuration" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,8"/>
                                <TextBlock Text="Configure the Model Context Protocol server for this project. These settings control how the agent connects to the MCP server."
                                           Foreground="{StaticResource TextSubdued}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,0,0,16"/>

                                <!-- Server Name -->
                                <TextBlock Text="Server Name" Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <TextBox x:Name="McpServerNameBox" Text="mcp-for-unity-server"
                                         Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                         CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                         FontSize="12" FontFamily="Segoe UI" Padding="8,6"
                                         LostFocus="McpSettings_Changed"/>
                                <TextBlock Text="Identifier used in the .mcp.json configuration file."
                                           Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI"
                                           Margin="0,4,0,0"/>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,16"/>

                                <!-- Server Address -->
                                <TextBlock Text="Server Address" Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,16,0,6"/>
                                <TextBox x:Name="McpAddressBox" Text="http://127.0.0.1:8080/mcp"
                                         Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                         CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="8,6"
                                         LostFocus="McpSettings_Changed"/>
                                <TextBlock Text="The HTTP URL of the MCP server endpoint."
                                           Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI"
                                           Margin="0,4,0,0"/>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,16"/>

                                <!-- Start Command -->
                                <TextBlock Text="Start Command" Foreground="{StaticResource TextLight}" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,16,0,6"/>
                                <TextBox x:Name="McpStartCommandBox"
                                         Background="{StaticResource BgDeep}" Foreground="{StaticResource TextLight}"
                                         CaretBrush="{StaticResource TextLight}" BorderBrush="{StaticResource BorderSubtle}" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="8,6"
                                         LostFocus="McpSettings_Changed"/>
                                <TextBlock Text="Shell command to start the MCP server (optional). Leave empty if the server is started externally."
                                           Foreground="{StaticResource TextDisabled}" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,4,0,0"/>

                                <Border Height="1" Background="{StaticResource BgElevated}" Margin="0,20"/>

                                <!-- Status / Actions -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Connection" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                </DockPanel>
                                <DockPanel>
                                    <TextBlock x:Name="McpConnectionStatus" Text="Disconnected"
                                               Foreground="{StaticResource TextMuted}" FontSize="12" FontFamily="Segoe UI"
                                               VerticalAlignment="Center" Margin="0,0,12,0"/>
                                    <Button x:Name="McpTestConnectionBtn" Content="Test Connection"
                                            Click="McpTestConnection_Click"
                                            Style="{StaticResource SecondaryBtn}"
                                            HorizontalAlignment="Left"
                                            Padding="14,7" FontSize="12"/>
                                </DockPanel>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                </TabControl>
                </DockPanel>
            </Border>

        <!-- Horizontal Splitter: Output ↔ Terminal -->
        <GridSplitter x:Name="TerminalSplitter" Grid.Row="3" Grid.Column="2" Style="{StaticResource HorizontalSplitter}" Visibility="Collapsed"/>

        <!-- ═══ TERMINAL (6) ═══ -->
        <Border Grid.Row="4" Grid.Column="2" Background="{StaticResource BgSurface}" CornerRadius="8" Padding="4"
                BorderThickness="1">
            <Border.BorderBrush>
                <SolidColorBrush x:Name="TerminalPanelBorder" Color="#2C2C2C"/>
            </Border.BorderBrush>
            <Border.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <ColorAnimation Storyboard.TargetName="TerminalPanelBorder"
                                            Storyboard.TargetProperty="Color"
                                            To="#3A3A3A" Duration="0:0:0.2"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <ColorAnimation Storyboard.TargetName="TerminalPanelBorder"
                                            Storyboard.TargetProperty="Color"
                                            To="#2C2C2C" Duration="0:0:0.3"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>
            <DockPanel>
                <!-- Root path display (very bottom) -->
                <Border x:Name="TerminalRootBar" DockPanel.Dock="Bottom" Background="{StaticResource BgDarkTerminal}" CornerRadius="0,0,6,6" Visibility="Collapsed"
                        Padding="8,3" Margin="0,2,0,0">
                    <TextBlock x:Name="TerminalRootPath"
                               Foreground="{StaticResource TextMuted}" FontFamily="Consolas" FontSize="10"
                               TextTrimming="CharacterEllipsis"
                               ToolTip="{Binding Text, RelativeSource={RelativeSource Self}}"/>
                </Border>
                <DockPanel x:Name="TerminalInputBar" DockPanel.Dock="Bottom" Margin="4,2,4,4" Visibility="Collapsed">
                    <Button x:Name="TerminalInterruptBtn" Content="Ctrl+C" DockPanel.Dock="Right"
                            Style="{StaticResource DangerBtn}"
                            FontWeight="Bold" FontSize="11"
                            Padding="10,4" Margin="4,0,0,0"
                            Click="TerminalInterrupt_Click" ToolTip="Send interrupt (Ctrl+C)"/>
                    <Button x:Name="TerminalSendBtn" Content="Send" DockPanel.Dock="Right"
                            Background="{StaticResource Accent}" Style="{StaticResource Btn}"
                            FontWeight="Bold" FontSize="12"
                            Padding="14,4" Margin="4,0,0,0"
                            Click="TerminalSend_Click"/>
                    <TextBox x:Name="TerminalInput"
                             Background="{StaticResource BgTerminalInput}" Foreground="{StaticResource TextBody}" CaretBrush="{StaticResource TextBody}"
                             BorderBrush="{StaticResource BgCard}" BorderThickness="1"
                             FontFamily="Consolas" FontSize="12"
                             Padding="8,4" VerticalContentAlignment="Center"
                             PreviewKeyDown="TerminalInput_PreviewKeyDown"/>
                </DockPanel>
                <DockPanel DockPanel.Dock="Top" Margin="8,4,8,2">
                    <Button x:Name="TerminalCollapseBtn" Content="&#xE70E;"
                            Style="{StaticResource IconBtn}" DockPanel.Dock="Left"
                            VerticalAlignment="Center" Margin="0,0,4,0"
                            Click="TerminalCollapse_Click" ToolTip="Expand terminal"/>
                    <TextBlock Text="TERMINAL" Foreground="{StaticResource Accent}" FontWeight="Bold"
                               FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"
                               Margin="0,0,8,0" MouseLeftButtonDown="TerminalHeader_MouseDown" Cursor="Hand"/>
                    <StackPanel x:Name="TerminalTabBar" Orientation="Horizontal" VerticalAlignment="Center" Visibility="Collapsed"/>
                </DockPanel>
                <TextBox x:Name="TerminalOutput" IsReadOnly="True" TextWrapping="Wrap"
                         VerticalScrollBarVisibility="Auto"
                         Background="{StaticResource BgAbyss}" Foreground="{StaticResource TextBody}"
                         FontFamily="Consolas" FontSize="12"
                         BorderThickness="0" Padding="8,4" Visibility="Collapsed"/>
            </DockPanel>
        </Border>

        <!-- ═══ STATUS BAR ═══ -->
        <Border Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="7" Background="{StaticResource BgSurface}" CornerRadius="6" Padding="12,7" Margin="0,8,0,0"
                BorderThickness="1">
            <Border.BorderBrush>
                <SolidColorBrush x:Name="StatusBarBorder" Color="#2C2C2C"/>
            </Border.BorderBrush>
            <Border.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <ColorAnimation Storyboard.TargetName="StatusBarBorder"
                                            Storyboard.TargetProperty="Color"
                                            To="#3A3A3A" Duration="0:0:0.2"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <ColorAnimation Storyboard.TargetName="StatusBarBorder"
                                            Storyboard.TargetProperty="Color"
                                            To="#2C2C2C" Duration="0:0:0.3"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>
            <TextBlock x:Name="StatusText" Foreground="{StaticResource TextSecondary}" FontSize="11" FontFamily="Segoe UI"
                       TextTrimming="CharacterEllipsis"/>
        </Border>

        <!-- Loading overlay shown during async startup -->
        <Border x:Name="LoadingOverlay" Grid.RowSpan="6" Grid.ColumnSpan="7"
                Background="{StaticResource BgOverlay}" CornerRadius="8"
                Visibility="Visible" Panel.ZIndex="1000">
            <TextBlock Text="Loading..." Foreground="{StaticResource TextSubdued}"
                       FontSize="16" FontFamily="Segoe UI"
                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
        </Border>
    </Grid>
</Window>
