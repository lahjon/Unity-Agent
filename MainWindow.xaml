<Window x:Class="AgenticEngine.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AgenticEngine"
        Title="Agentic Engine" Width="1280" Height="820"
        Background="#191919" WindowStartupLocation="CenterScreen"
        Loaded="Window_Loaded"
        PreviewKeyDown="Window_PreviewKeyDown">

    <Window.Resources>
        <!-- ═══ ACTIVE TASK ═══ -->
        <DataTemplate x:Key="ActiveTaskTemplate">
            <Border x:Name="Card" CornerRadius="8" Padding="10" Margin="0,2"
                    BorderThickness="1"
                    MouseUp="TaskCard_MouseUp"
                    MouseMove="TaskCard_MouseMove">
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Copy Prompt" Click="CopyPrompt_Click"/>
                    </ContextMenu>
                </Border.ContextMenu>
                <Border.Background>
                    <SolidColorBrush x:Name="CardBg" Color="#222222"/>
                </Border.Background>
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="CardBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="CardBg" Storyboard.TargetProperty="Color"
                                                To="#2A2A2A" Duration="0:0:0.15"/>
                                <ColorAnimation Storyboard.TargetName="CardBorder" Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.15"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="CardBg" Storyboard.TargetProperty="Color"
                                                To="#222222" Duration="0:0:0.2"/>
                                <ColorAnimation Storyboard.TargetName="CardBorder" Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <!-- Top-right buttons -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal"
                                HorizontalAlignment="Right" VerticalAlignment="Top"
                                Margin="0,-2,-2,0">
                        <!-- Pause/Resume button -->
                        <Button Click="Pause_Click" Margin="0,0,2,0">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE769;"/>
                                    <Setter Property="Foreground" Value="#DA7756"/>
                                    <Setter Property="ToolTip" Value="Pause task"/>
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPaused}" Value="True">
                                            <Setter Property="Content" Value="&#xE768;"/>
                                            <Setter Property="Foreground" Value="#E89B7E"/>
                                            <Setter Property="ToolTip" Value="Resume task"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsFinished}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsQueued}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                        <DataTrigger Binding="{Binding IsInitQueued}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                        <!-- Close/Remove button -->
                        <Button Click="Cancel_Click">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE8BB;"/>
                                    <Setter Property="ToolTip" Value="Cancel task"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsFinished}" Value="True">
                                            <Setter Property="Content" Value="&#xE73E;"/>
                                            <Setter Property="Foreground" Value="#5CB85C"/>
                                            <Setter Property="ToolTip" Value="Remove task"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </StackPanel>
                    <StackPanel Grid.Row="0" Orientation="Horizontal">
                        <Grid Width="8" Height="8" Margin="0,0,6,0" VerticalAlignment="Center">
                            <Ellipse x:Name="StatusGlow" Width="8" Height="8"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Effect">
                                            <Setter.Value>
                                                <BlurEffect Radius="0"/>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRunning}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="GlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="10" Duration="0:0:0.8"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1.0" Duration="0:0:0.8"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="GlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsQueued}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="QueuedGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="8" Duration="0:0:1.2"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.4" To="1.0" Duration="0:0:1.2"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="QueuedGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsInitQueued}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="InitQueuedGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1.0" Duration="0:0:1.5"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="InitQueuedGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsPaused}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="PausedGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1.0" Duration="0:0:2.0"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="PausedGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <Ellipse x:Name="StatusDot" Width="8" Height="8"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}"/>
                        </Grid>
                        <TextBlock Text="{Binding StatusText}"
                                   Foreground="{Binding StatusColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="11" FontWeight="SemiBold" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text=" | " Foreground="#444" FontSize="11" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ProjectName}" Foreground="#888"
                                   FontSize="11" FontFamily="Segoe UI" VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis" MaxWidth="100"
                                   ToolTip="{Binding ProjectPath}"/>
                        <TextBlock Text="{Binding TaskNumber, StringFormat='#{0:D4}'}"
                                   Foreground="{Binding ProjectColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="10" FontFamily="Consolas" Margin="8,0,0,0"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Grid.Row="1" Text="{Binding ShortDescription}"
                               Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"
                               TextTrimming="CharacterEllipsis" Margin="0,4,0,0">
                        <TextBlock.ToolTip>
                            <ToolTip MaxWidth="600" Placement="Bottom">
                                <TextBlock Text="{Binding Description}" TextWrapping="Wrap" MaxWidth="580"/>
                            </ToolTip>
                        </TextBlock.ToolTip>
                    </TextBlock>
                    <!-- Tool activity feed (last 3 actions) -->
                    <TextBlock Grid.Row="2" Text="{Binding ToolActivityText}"
                               Foreground="#7A9EC2" FontSize="10" FontFamily="Consolas"
                               TextTrimming="CharacterEllipsis" Margin="0,4,0,0"
                               LineHeight="15">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <MultiDataTrigger>
                                        <MultiDataTrigger.Conditions>
                                            <Condition Binding="{Binding IsRunning}" Value="True"/>
                                            <Condition Binding="{Binding HasToolActivity}" Value="True"/>
                                        </MultiDataTrigger.Conditions>
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </MultiDataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                    <Grid Grid.Row="3" Margin="0,6,0,0">
                        <TextBlock Text="{Binding TimeInfo}" Foreground="#666"
                                   FontSize="10" VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <Border CornerRadius="3" Padding="4,1"
                                Background="#2A1F3D" BorderBrush="#7E57C2" BorderThickness="1"
                                HorizontalAlignment="Right" VerticalAlignment="Center">
                            <Border.Style>
                                <Style TargetType="Border">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding PlanOnly}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Border.Style>
                            <TextBlock Text="PLAN" Foreground="#CE93D8" FontSize="9"
                                       FontFamily="Segoe UI" FontWeight="Bold"/>
                        </Border>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- ═══ HISTORY TASK ═══ -->
        <DataTemplate x:Key="HistoryTaskTemplate">
            <Border CornerRadius="8" Padding="10" Margin="0,2"
                    BorderThickness="1">
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Copy Prompt" Click="CopyPrompt_Click"/>
                    </ContextMenu>
                </Border.ContextMenu>
                <Border.Background>
                    <SolidColorBrush x:Name="HistCardBg" Color="#222222"/>
                </Border.Background>
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="HistCardBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="HistCardBg" Storyboard.TargetProperty="Color"
                                                To="#282828" Duration="0:0:0.15"/>
                                <ColorAnimation Storyboard.TargetName="HistCardBorder" Storyboard.TargetProperty="Color"
                                                To="#383838" Duration="0:0:0.15"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="HistCardBg" Storyboard.TargetProperty="Color"
                                                To="#222222" Duration="0:0:0.2"/>
                                <ColorAnimation Storyboard.TargetName="HistCardBorder" Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <!-- Close X button top-right -->
                    <Button Grid.Row="0" Content="&#xE8BB;" Click="RemoveHistoryTask_Click"
                            HorizontalAlignment="Right" VerticalAlignment="Top"
                            Style="{StaticResource IconBtn}" Margin="0,-2,-2,0"
                            ToolTip="Remove from history"/>
                    <StackPanel Grid.Row="0" Orientation="Horizontal">
                        <Grid Width="8" Height="8" Margin="0,0,6,0" VerticalAlignment="Center">
                            <Ellipse x:Name="HistStatusGlow" Width="8" Height="8"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}">
                                <Ellipse.Style>
                                    <Style TargetType="Ellipse">
                                        <Setter Property="Effect">
                                            <Setter.Value>
                                                <BlurEffect Radius="0"/>
                                            </Setter.Value>
                                        </Setter>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsRunning}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="HistGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="10" Duration="0:0:0.8"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.3" To="1.0" Duration="0:0:0.8"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="HistGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding IsQueued}" Value="True">
                                                <DataTrigger.EnterActions>
                                                    <BeginStoryboard x:Name="HistQueuedGlowStoryboard">
                                                        <Storyboard RepeatBehavior="Forever">
                                                            <DoubleAnimation Storyboard.TargetProperty="(UIElement.Effect).(BlurEffect.Radius)"
                                                                             From="0" To="8" Duration="0:0:1.2"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                                                             From="0.4" To="1.0" Duration="0:0:1.2"
                                                                             AutoReverse="True">
                                                                <DoubleAnimation.EasingFunction>
                                                                    <SineEase EasingMode="EaseInOut"/>
                                                                </DoubleAnimation.EasingFunction>
                                                            </DoubleAnimation>
                                                        </Storyboard>
                                                    </BeginStoryboard>
                                                </DataTrigger.EnterActions>
                                                <DataTrigger.ExitActions>
                                                    <StopStoryboard BeginStoryboardName="HistQueuedGlowStoryboard"/>
                                                </DataTrigger.ExitActions>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Ellipse.Style>
                            </Ellipse>
                            <Ellipse x:Name="HistStatusDot" Width="8" Height="8"
                                     Fill="{Binding StatusColor, Converter={StaticResource StringToBrush}}"/>
                        </Grid>
                        <TextBlock Text="{Binding StatusText}"
                                   Foreground="{Binding StatusColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="11" FontWeight="SemiBold" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text=" | " Foreground="#444" FontSize="11" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ProjectName}" Foreground="#666"
                                   FontSize="11" FontFamily="Segoe UI" VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis" MaxWidth="100"
                                   ToolTip="{Binding ProjectPath}"/>
                        <TextBlock Text="{Binding TaskNumber, StringFormat='#{0:D4}'}"
                                   Foreground="{Binding ProjectColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="10" FontFamily="Consolas" Margin="8,0,0,0"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Grid.Row="1" Text="{Binding ShortDescription}"
                               Foreground="#888" FontSize="12" FontFamily="Segoe UI"
                               TextTrimming="CharacterEllipsis" Margin="0,4,0,0">
                        <TextBlock.ToolTip>
                            <ToolTip MaxWidth="600" Placement="Bottom">
                                <TextBlock Text="{Binding Description}" TextWrapping="Wrap" MaxWidth="580"/>
                            </ToolTip>
                        </TextBlock.ToolTip>
                    </TextBlock>
                    <Grid Grid.Row="2" Margin="0,6,0,0">
                        <TextBlock Text="{Binding TimeInfo}" Foreground="#555"
                                   FontSize="10" VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Border CornerRadius="3" Padding="4,1" Margin="0,0,8,0"
                                    Background="#2A1F3D" BorderBrush="#7E57C2" BorderThickness="1"
                                    VerticalAlignment="Center">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding PlanOnly}" Value="True">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <TextBlock Text="PLAN" Foreground="#CE93D8" FontSize="9"
                                           FontFamily="Segoe UI" FontWeight="Bold"/>
                            </Border>
                            <Button Content="Resume" Click="Resume_Click"
                                    Background="#DA7756" Style="{StaticResource SmallBtn}"
                                    Margin="0"/>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>

        <!-- ═══ STORED TASK ═══ -->
        <DataTemplate x:Key="StoredTaskTemplate">
            <Border CornerRadius="8" Padding="10" Margin="0,2"
                    BorderThickness="1">
                <Border.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Copy Stored Prompt" Click="CopyStoredPrompt_Click"/>
                        <MenuItem Header="Copy Original Prompt" Click="CopyPrompt_Click"/>
                    </ContextMenu>
                </Border.ContextMenu>
                <Border.Background>
                    <SolidColorBrush x:Name="StoredCardBg" Color="#1E2428"/>
                </Border.Background>
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="StoredCardBorder" Color="#2A3A3A"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="StoredCardBg" Storyboard.TargetProperty="Color"
                                                To="#253030" Duration="0:0:0.15"/>
                                <ColorAnimation Storyboard.TargetName="StoredCardBorder" Storyboard.TargetProperty="Color"
                                                To="#3A4A4A" Duration="0:0:0.15"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="StoredCardBg" Storyboard.TargetProperty="Color"
                                                To="#1E2428" Duration="0:0:0.2"/>
                                <ColorAnimation Storyboard.TargetName="StoredCardBorder" Storyboard.TargetProperty="Color"
                                                To="#2A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <!-- Close X button top-right -->
                    <Button Grid.Row="0" Content="&#xE8BB;" Click="RemoveStoredTask_Click"
                            HorizontalAlignment="Right" VerticalAlignment="Top"
                            Style="{StaticResource IconBtn}" Margin="0,-2,-2,0"
                            ToolTip="Remove stored task"/>
                    <StackPanel Grid.Row="0" Orientation="Horizontal">
                        <Grid Width="8" Height="8" Margin="0,0,6,0" VerticalAlignment="Center">
                            <Ellipse Width="8" Height="8" Fill="#4DB6AC"/>
                        </Grid>
                        <TextBlock Text="Stored" Foreground="#4DB6AC"
                                   FontSize="11" FontWeight="SemiBold" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text=" | " Foreground="#444" FontSize="11" FontFamily="Segoe UI"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ProjectName}" Foreground="#666"
                                   FontSize="11" FontFamily="Segoe UI" VerticalAlignment="Center"
                                   TextTrimming="CharacterEllipsis" MaxWidth="100"
                                   ToolTip="{Binding ProjectPath}"/>
                        <TextBlock Text="{Binding TaskNumber, StringFormat='#{0:D4}'}"
                                   Foreground="{Binding ProjectColor, Converter={StaticResource StringToBrush}}"
                                   FontSize="10" FontFamily="Consolas" Margin="8,0,0,0"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Grid.Row="1" Text="{Binding ShortDescription}"
                               Foreground="#888" FontSize="12" FontFamily="Segoe UI"
                               TextTrimming="CharacterEllipsis" Margin="0,4,0,0">
                        <TextBlock.ToolTip>
                            <ToolTip MaxWidth="600" Placement="Bottom">
                                <TextBlock Text="{Binding StoredPrompt}" TextWrapping="Wrap" MaxWidth="580"/>
                            </ToolTip>
                        </TextBlock.ToolTip>
                    </TextBlock>
                    <Grid Grid.Row="2" Margin="0,6,0,0">
                        <TextBlock Text="{Binding TimeInfo}" Foreground="#555"
                                   FontSize="10" VerticalAlignment="Center" FontFamily="Segoe UI"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="View" Click="ViewStoredTask_Click"
                                    Background="#333" Style="{StaticResource SmallBtn}"
                                    Margin="0,0,6,0"/>
                            <Button Content="Execute" Click="ExecuteStoredTask_Click"
                                    Background="#4DB6AC" Style="{StaticResource SmallBtn}"
                                    Margin="0"/>
                        </StackPanel>
                    </Grid>
                </Grid>
            </Border>
        </DataTemplate>
    </Window.Resources>

    <Grid x:Name="RootGrid" Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" MinHeight="120"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="180" MinHeight="60"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition x:Name="TerminalRow" Height="Auto" MinHeight="0"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="285" MinWidth="150"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*" MinWidth="200"/>
            <ColumnDefinition x:Name="RightSplitterCol" Width="Auto"/>
            <ColumnDefinition x:Name="RightPanelCol" Width="285" MinWidth="150"/>
        </Grid.ColumnDefinitions>

        <!-- ═══ PROJECTS (1) ═══ -->
        <Border Grid.Row="2" Grid.Column="0" Grid.RowSpan="3" Background="#222222" CornerRadius="8" Padding="10"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="ProjectsPanelBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="ProjectsPanelBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="ProjectsPanelBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <DockPanel>
                    <!-- Add / Create Project form -->
                    <Border DockPanel.Dock="Bottom" Background="#1E1E1E" CornerRadius="6"
                            BorderBrush="#333333" BorderThickness="1" Margin="0,6,0,0" Padding="8">
                        <StackPanel>
                            <DockPanel>
                                <TextBlock Text="ADD" Foreground="#DA7756" FontWeight="Bold"
                                           FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"
                                           DockPanel.Dock="Left" Margin="0,0,6,0"/>
                                <Button Content="Add" Click="AddProject_Click"
                                        Background="#DA7756" Style="{StaticResource SmallBtn}"
                                        DockPanel.Dock="Right" Margin="4,0,0,0" Padding="10,3"/>
                                <Border Background="#191919" BorderBrush="#333333" BorderThickness="1"
                                        CornerRadius="2" Cursor="Hand"
                                        MouseLeftButtonDown="AddProjectPath_Click">
                                    <TextBlock x:Name="AddProjectPath"
                                               Foreground="#666" FontSize="11"
                                               FontFamily="Segoe UI" Padding="6,4"
                                               Text="Click to select project folder..."
                                               VerticalAlignment="Center"/>
                                </Border>
                            </DockPanel>
                            <Button Content="Create New Project" Click="CreateProject_Click"
                                    Background="#DA7756" Style="{StaticResource SmallBtn}"
                                    HorizontalAlignment="Stretch" Margin="0,6,0,0" Padding="10,5"/>
                        </StackPanel>
                    </Border>
                    <!-- Header -->
                    <TextBlock DockPanel.Dock="Top" Text="PROJECTS" Foreground="#DA7756" FontWeight="Bold"
                               FontSize="10" FontFamily="Segoe UI" Margin="4,2,0,6"/>
                    <!-- Project list -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel x:Name="ProjectListPanel" Margin="0"/>
                    </ScrollViewer>
                </DockPanel>
            </Border>

        <!-- Vertical Splitter: Left ↔ Center/Right -->
        <GridSplitter Grid.Column="1" Grid.RowSpan="5" Style="{StaticResource VerticalSplitter}"/>

        <!-- ═══ PROMPTS (2) ═══ -->
        <Border Grid.Row="2" Grid.Column="2" Grid.ColumnSpan="3" Background="#222222" CornerRadius="8" Padding="14"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="InputSectionBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="InputSectionBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="InputSectionBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition x:Name="ChatSplitterCol" Width="Auto"/>
                        <ColumnDefinition x:Name="ChatPanelCol" Width="280" MinWidth="0"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left: Prompt input area -->
                <DockPanel Grid.Column="0">
                    <!-- Bottom: Advanced expander + Execute button (always visible) -->
                    <DockPanel DockPanel.Dock="Bottom" Margin="0,8,0,0">
                        <StackPanel DockPanel.Dock="Right" Margin="10,0,0,0" VerticalAlignment="Top">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                <TextBlock x:Name="PromptProjectLabel" Text="" Foreground="#E8E8E8" FontFamily="Segoe UI"
                                           FontSize="16" FontWeight="SemiBold" VerticalAlignment="Center" Margin="0,0,12,0"
                                           TextTrimming="CharacterEllipsis" MaxWidth="400"/>
                                <Button Content="Save Prompt" Click="SavePromptEntry_Click"
                                        Background="#353535" Style="{StaticResource Btn}"
                                        Foreground="#A8A8A8"
                                        FontSize="11" Padding="6,4" Margin="0,0,6,0"/>
                                <Button x:Name="ExecuteButton" Content="Execute Task" Click="Execute_Click"
                                        Background="#DA7756" Style="{StaticResource Btn}"
                                        FontSize="13" Padding="18,6" FontWeight="Bold"/>
                            </StackPanel>
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,4,0,0">
                                <TextBlock Text="Ctrl+S to save" Foreground="#555" FontFamily="Segoe UI"
                                           FontSize="10" Margin="0,0,12,0"/>
                                <TextBlock Text="Ctrl+Enter to execute" Foreground="#555" FontFamily="Segoe UI"
                                           FontSize="10"/>
                            </StackPanel>
                        </StackPanel>
                        <Expander Style="{StaticResource DarkExpander}" IsExpanded="False">
                            <Expander.Header>
                                <TextBlock Text="ADVANCED" Foreground="#DA7756" FontWeight="Bold" FontSize="10"
                                           FontFamily="Segoe UI"/>
                            </Expander.Header>
                            <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="200">
                                <StackPanel Margin="0,2,0,0">
                                    <!-- Permanent toggles -->
                                    <WrapPanel>
                                        <ToggleButton x:Name="IgnoreFileLocksToggle" IsChecked="True"
                                                      Style="{StaticResource ToggleSwitch}" Margin="0,0,12,8">
                                            <TextBlock Text="Ignore File Locks" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="UseMcpToggle" IsChecked="False"
                                                      Style="{StaticResource ToggleSwitch}" Margin="0,0,12,8">
                                            <TextBlock Text="Use MCP" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"/>
                                        </ToggleButton>
                                    </WrapPanel>
                                    <!-- Separator -->
                                    <Border BorderBrush="#444" BorderThickness="0,1,0,0" Margin="0,2,0,6"/>
                                    <!-- Per-task toggles (reset after execution) -->
                                    <WrapPanel>
                                        <ToggleButton x:Name="RemoteSessionToggle" IsChecked="False"
                                                      Style="{StaticResource ToggleSwitch}" Margin="0,0,12,8">
                                            <TextBlock Text="Remote Session" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="HeadlessToggle" IsChecked="False"
                                                      Style="{StaticResource ToggleSwitch}" Margin="0,0,12,8">
                                            <TextBlock Text="Headless (Terminal)" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="SpawnTeamToggle" IsChecked="False"
                                                      Style="{StaticResource ToggleSwitch}" Margin="0,0,12,8">
                                            <TextBlock Text="Spawn Team" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="OvernightToggle" IsChecked="False"
                                                      Style="{StaticResource ToggleSwitch}" Margin="0,0,12,8"
                                                      Checked="OvernightToggle_Changed" Unchecked="OvernightToggle_Changed">
                                            <TextBlock Text="Overnight Task" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="ExtendedPlanningToggle" IsChecked="False"
                                                      Style="{StaticResource ToggleSwitch}" Margin="0,0,12,8">
                                            <TextBlock Text="Extended Planning" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"/>
                                        </ToggleButton>
                                        <ToggleButton x:Name="PlanOnlyToggle" IsChecked="False"
                                                      Style="{StaticResource ToggleSwitch}" Margin="0,0,12,8"
                                                      Checked="PlanOnlyToggle_Changed" Unchecked="PlanOnlyToggle_Changed">
                                            <TextBlock Text="Plan Only" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"/>
                                        </ToggleButton>
                                    </WrapPanel>
                                </StackPanel>
                            </ScrollViewer>
                        </Expander>
                    </DockPanel>
                    <!-- Top: Prompt label, model selector, text input -->
                    <DockPanel>
                        <!-- Panel label + Model selector -->
                        <DockPanel DockPanel.Dock="Top" Margin="0,0,0,6">
                            <TextBlock Text="PROMPT" Foreground="#DA7756" FontWeight="Bold"
                                       FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                            <TextBlock Text="MODEL" Foreground="#666" FontWeight="Bold"
                                       FontSize="9" FontFamily="Segoe UI" VerticalAlignment="Center"
                                       Margin="20,0,6,0"/>
                            <ComboBox x:Name="ModelCombo" SelectedIndex="0"
                                      FontSize="11" Padding="6,3" MinWidth="170"
                                      HorizontalAlignment="Left"
                                      SelectionChanged="ModelCombo_Changed">
                                <ComboBoxItem Content="Claude Code" Tag="ClaudeCode"/>
                                <ComboBoxItem Content="Gemini (Image Gen)" Tag="Gemini"/>
                            </ComboBox>
                        </DockPanel>
                        <!-- Active project name removed from here; shown next to Execute button -->
                        <StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" Margin="0,6,0,0">
                            <TextBlock x:Name="ImageIndicator" Foreground="#DA7756" FontSize="11"
                                       FontFamily="Segoe UI" VerticalAlignment="Center" Visibility="Collapsed"/>
                            <Button x:Name="ClearImagesBtn" Content="Clear" Click="ClearImages_Click"
                                    Style="{StaticResource GhostBtn}" Foreground="#A15252"
                                    Margin="6,0,0,0" Visibility="Collapsed"/>
                        </StackPanel>
                        <!-- Dependency drop zone -->
                        <Border x:Name="DependencyDropZone" DockPanel.Dock="Bottom"
                                Background="#1A1A1A" BorderBrush="#333333" BorderThickness="1"
                                CornerRadius="4" MinHeight="28" Margin="0,6,0,0" Padding="6,4"
                                AllowDrop="True"
                                PreviewDragOver="DependencyZone_DragOver"
                                Drop="DependencyZone_Drop">
                            <DockPanel>
                                <TextBlock DockPanel.Dock="Left" Text="DEPS" Foreground="#DA7756" FontWeight="Bold"
                                           FontSize="9" FontFamily="Segoe UI" VerticalAlignment="Center"
                                           Margin="0,0,8,0"/>
                                <TextBlock x:Name="DependencyPlaceholder" Text="Drag tasks here to add dependencies..."
                                           Foreground="#555" FontSize="11" FontFamily="Segoe UI"
                                           VerticalAlignment="Center"/>
                                <ItemsControl x:Name="DependencyChips" Visibility="Collapsed">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                </ItemsControl>
                            </DockPanel>
                        </Border>
                        <TextBox x:Name="TaskInput" AcceptsReturn="True" TextWrapping="Wrap"
                                 MinHeight="80" MaxHeight="150"
                                 VerticalScrollBarVisibility="Auto"
                                 Background="#191919" Foreground="#E8E8E8"
                                 CaretBrush="#E8E8E8" BorderBrush="#333333" BorderThickness="1"
                                 FontSize="13" FontFamily="Consolas" Padding="10"
                                 PreviewKeyDown="TaskInput_PreviewKeyDown"
                                 AllowDrop="True" PreviewDragOver="TaskInput_DragOver"
                                 Drop="TaskInput_Drop"/>
                    </DockPanel>
                </DockPanel>

                    <!-- Center-right: Saved Prompts panel -->
                    <Border Grid.Column="1" Background="{StaticResource BgSurface}" CornerRadius="6"
                            BorderBrush="{StaticResource BgElevated}" BorderThickness="1" Margin="10,0,0,0"
                            Padding="8" MinWidth="180" MaxWidth="220">
                        <DockPanel>
                            <TextBlock DockPanel.Dock="Top" Text="SAVED" Foreground="#4DB6AC" FontWeight="Bold"
                                       FontSize="10" FontFamily="Segoe UI" Margin="0,0,0,6"/>
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <StackPanel x:Name="SavedPromptsPanel"/>
                            </ScrollViewer>
                        </DockPanel>
                    </Border>

                    <!-- Splitter: Content ↔ Chat -->
                    <GridSplitter x:Name="ChatSplitter" Grid.Column="2" Width="4" Background="Transparent"
                                  HorizontalAlignment="Center" VerticalAlignment="Stretch"
                                  Cursor="SizeWE"/>

                    <!-- Right: Collapsible Chat panel -->
                    <Grid Grid.Column="3" Margin="4,0,0,0">
                        <!-- Collapsed strip -->
                        <Border x:Name="ChatCollapsedStrip" Visibility="Collapsed"
                                Background="{StaticResource BgSurface}" CornerRadius="6"
                                BorderBrush="{StaticResource BgElevated}" BorderThickness="1"
                                Padding="4" Width="28" Cursor="Hand"
                                MouseLeftButtonUp="ChatToggle_Click">
                            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                                <TextBlock Text="&#xE76B;" FontFamily="Segoe MDL2 Assets" FontSize="12"
                                           Foreground="{StaticResource Accent}" HorizontalAlignment="Center"
                                           Margin="0,0,0,6"/>
                                <TextBlock Text="C&#x0A;H&#x0A;A&#x0A;T" Foreground="{StaticResource Accent}"
                                           FontWeight="Bold" FontSize="9" FontFamily="Segoe UI"
                                           TextAlignment="Center" LineHeight="14"/>
                            </StackPanel>
                        </Border>
                        <!-- Expanded panel -->
                        <Border x:Name="ChatExpandedPanel" Background="{StaticResource BgSurface}" CornerRadius="6"
                                BorderBrush="{StaticResource BgElevated}" BorderThickness="1" Padding="8">
                            <DockPanel>
                                <!-- Header with collapse + New Chat buttons -->
                                <DockPanel DockPanel.Dock="Top" Margin="0,0,0,6">
                                    <Button Content="&#xE76C;" Click="ChatToggle_Click"
                                            FontFamily="Segoe MDL2 Assets" FontSize="10"
                                            Style="{StaticResource IconBtn}" Foreground="{StaticResource Accent}"
                                            Padding="4,2" ToolTip="Collapse chat" Margin="0,0,6,0"
                                            VerticalAlignment="Center"/>
                                    <TextBlock Text="CHAT" Foreground="{StaticResource Accent}" FontWeight="Bold"
                                               FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <Button x:Name="NewChatBtn" Content="New Chat" Click="NewChat_Click"
                                            Style="{StaticResource GhostBtn}" Foreground="{StaticResource Accent}"
                                            HorizontalAlignment="Right" FontSize="10"/>
                                </DockPanel>
                                <!-- Input area at the bottom -->
                                <DockPanel DockPanel.Dock="Bottom" Margin="0,6,0,0">
                                    <Button x:Name="ChatSendBtn" Content="&#xE724;" Click="ChatSend_Click"
                                            DockPanel.Dock="Right" Margin="4,0,0,0" VerticalAlignment="Bottom"
                                            Padding="6,6" FontSize="13" ToolTip="Send message">
                                        <Button.Style>
                                            <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                                <Setter Property="Foreground" Value="{StaticResource Accent}"/>
                                            </Style>
                                        </Button.Style>
                                    </Button>
                                    <TextBox x:Name="ChatInput" AcceptsReturn="False" TextWrapping="Wrap"
                                             MaxHeight="60" MinHeight="28"
                                             VerticalScrollBarVisibility="Auto"
                                             Background="{StaticResource BgDeep}" Foreground="{StaticResource TextPrimary}"
                                             CaretBrush="{StaticResource TextPrimary}" BorderBrush="{StaticResource BorderSubtle}"
                                             BorderThickness="1" FontSize="12" FontFamily="Segoe UI" Padding="6,4"
                                             PreviewKeyDown="ChatInput_PreviewKeyDown"
                                             VerticalContentAlignment="Center"/>
                                </DockPanel>
                                <!-- Chat messages -->
                                <ScrollViewer x:Name="ChatScrollViewer" VerticalScrollBarVisibility="Auto">
                                    <StackPanel x:Name="ChatMessagesPanel"/>
                                </ScrollViewer>
                            </DockPanel>
                        </Border>
                    </Grid>
                </Grid>
            </Border>

        <!-- Horizontal Splitter: Top ↔ Middle -->
        <GridSplitter Grid.Row="1" Grid.ColumnSpan="5" Style="{StaticResource HorizontalSplitter}"/>

        <!-- ═══ TASK LIST (3) ═══ -->
        <Border Grid.Row="0" Grid.Column="0" Background="#222222" CornerRadius="8" Padding="10"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="SidebarBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="SidebarBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="SidebarBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <TextBlock Grid.Row="0" Text="TASK LIST" Foreground="#DA7756" FontWeight="Bold"
                               FontSize="10" FontFamily="Segoe UI" Margin="4,2,0,6"/>
                <TabControl Grid.Row="1" Background="Transparent" BorderThickness="0"
                           SelectionChanged="TaskListTab_SelectionChanged">
                    <TabItem>
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ACTIVE" FontWeight="Bold" FontSize="11" FontFamily="Segoe UI"/>
                                <TextBlock x:Name="ActiveTabCount" FontWeight="Bold" FontSize="11"
                                           FontFamily="Segoe UI" Foreground="#888"/>
                            </StackPanel>
                        </TabItem.Header>
                        <Grid Margin="0,6,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <DockPanel Grid.Row="0" Margin="4,0,0,8">
                                <Button Content="Clear" Click="ClearFinished_Click"
                                        Style="{StaticResource GhostBtn}" DockPanel.Dock="Right"/>
                                <StackPanel Orientation="Horizontal">
                                    <ComboBox x:Name="ActiveFilterCombo" SelectionChanged="ActiveFilter_Changed"
                                              FontSize="10" Padding="6,3"
                                              HorizontalAlignment="Left"/>
                                    <ComboBox x:Name="ActiveStatusFilterCombo" SelectionChanged="ActiveStatusFilter_Changed"
                                              FontSize="10" Padding="6,3" Margin="4,0,0,0"
                                              HorizontalAlignment="Left"/>
                                </StackPanel>
                            </DockPanel>
                            <ListBox x:Name="ActiveTasksList" Grid.Row="1"
                                     Style="{StaticResource TaskListStyle}"
                                     ItemTemplate="{StaticResource ActiveTaskTemplate}"
                                     SelectionChanged="ActiveTask_Selected"
                                     PreviewMouseWheel="TaskList_PreviewMouseWheel"/>
                        </Grid>
                    </TabItem>
                    <TabItem>
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="HISTORY" FontWeight="Bold" FontSize="11" FontFamily="Segoe UI"/>
                                <TextBlock x:Name="HistoryTabCount" FontWeight="Bold" FontSize="11"
                                           FontFamily="Segoe UI" Foreground="#888"/>
                            </StackPanel>
                        </TabItem.Header>
                        <Grid Margin="0,6,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <DockPanel Grid.Row="0" Margin="4,0,0,8">
                                <Button Content="Clear" Click="ClearHistory_Click"
                                        Style="{StaticResource GhostBtn}" DockPanel.Dock="Right"/>
                                <StackPanel Orientation="Horizontal">
                                    <ComboBox x:Name="HistoryFilterCombo" SelectionChanged="HistoryFilter_Changed"
                                              FontSize="10" Padding="6,3" Margin="0,0,4,0"
                                              HorizontalAlignment="Left"/>
                                    <ComboBox x:Name="HistoryStatusFilterCombo" SelectionChanged="HistoryStatusFilter_Changed"
                                              FontSize="10" Padding="6,3"
                                              HorizontalAlignment="Left"/>
                                </StackPanel>
                            </DockPanel>
                            <ListBox x:Name="HistoryTasksList" Grid.Row="1"
                                     Style="{StaticResource TaskListStyle}"
                                     ItemTemplate="{StaticResource HistoryTaskTemplate}"
                                     SelectionChanged="HistoryTask_Selected"
                                     PreviewMouseWheel="TaskList_PreviewMouseWheel"/>
                        </Grid>
                    </TabItem>
                    <TabItem x:Name="StoredTabItem">
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="STORED" FontWeight="Bold" FontSize="11" FontFamily="Segoe UI"/>
                                <TextBlock x:Name="StoredTabBadge" FontWeight="Bold" FontSize="11"
                                           FontFamily="Segoe UI" Foreground="#4DB6AC" Visibility="Collapsed"/>
                            </StackPanel>
                        </TabItem.Header>
                        <Grid Margin="0,6,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            <DockPanel Grid.Row="0" Margin="4,0,0,8">
                                <Button Content="Clear" Click="ClearStoredTasks_Click"
                                        Style="{StaticResource GhostBtn}" DockPanel.Dock="Right"/>
                                <ComboBox x:Name="StoredFilterCombo" SelectionChanged="StoredFilter_Changed"
                                          FontSize="10" Padding="6,3"
                                          HorizontalAlignment="Left"/>
                            </DockPanel>
                            <ListBox x:Name="StoredTasksList" Grid.Row="1"
                                     Style="{StaticResource TaskListStyle}"
                                     ItemTemplate="{StaticResource StoredTaskTemplate}"
                                     PreviewMouseWheel="TaskList_PreviewMouseWheel"/>
                        </Grid>
                    </TabItem>
                </TabControl>
                </Grid>
            </Border>

        <!-- ═══ TASK OUTPUT (4) ═══ -->
        <Border Grid.Row="0" Grid.Column="2" Background="#222222" CornerRadius="8" Padding="4"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="MainContentBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="MainContentBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="MainContentBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="TASK OUTPUT" Foreground="#DA7756" FontWeight="Bold"
                               FontSize="10" FontFamily="Segoe UI" Margin="8,6,0,4"/>
                    <TabControl x:Name="OutputTabs" Style="{StaticResource OutputTabControlStyle}"
                                SizeChanged="OutputTabs_SizeChanged"/>
                </DockPanel>
            </Border>

        <!-- Vertical Splitter: Center ↔ Right -->
        <GridSplitter x:Name="RightSplitter" Grid.Column="3" Grid.Row="0" Style="{StaticResource VerticalSplitter}"/>

        <!-- ═══ SETTINGS (5) ═══ -->
        <!-- Collapsed strip (shown when panel is collapsed) -->
        <Border x:Name="SettingsCollapsedStrip" Grid.Row="0" Grid.Column="4"
                Background="#222222" CornerRadius="8" Padding="0" Visibility="Collapsed"
                BorderThickness="1" BorderBrush="#2C2C2C" Width="32">
            <Button x:Name="ExpandSettingsBtn" Click="ToggleSettingsPanel_Click"
                    ToolTip="Expand Settings" VerticalAlignment="Top" HorizontalAlignment="Center"
                    Margin="0,6,0,0">
                <Button.Style>
                    <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                        <Setter Property="Content" Value="&#xE76B;"/>
                        <Setter Property="FontSize" Value="12"/>
                        <Setter Property="Foreground" Value="#DA7756"/>
                    </Style>
                </Button.Style>
            </Button>
        </Border>
        <!-- Expanded settings panel -->
        <Border x:Name="SettingsExpandedPanel" Grid.Row="0" Grid.Column="4" Background="#222222" CornerRadius="8" Padding="4"
                BorderThickness="1">
                <Border.BorderBrush>
                    <SolidColorBrush x:Name="RightPanelBorder" Color="#2C2C2C"/>
                </Border.BorderBrush>
                <Border.Triggers>
                    <EventTrigger RoutedEvent="MouseEnter">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="RightPanelBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#3A3A3A" Duration="0:0:0.2"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                    <EventTrigger RoutedEvent="MouseLeave">
                        <BeginStoryboard>
                            <Storyboard>
                                <ColorAnimation Storyboard.TargetName="RightPanelBorder"
                                                Storyboard.TargetProperty="Color"
                                                To="#2C2C2C" Duration="0:0:0.3"/>
                            </Storyboard>
                        </BeginStoryboard>
                    </EventTrigger>
                </Border.Triggers>
                <DockPanel>
                    <DockPanel DockPanel.Dock="Top" Margin="8,6,4,4">
                        <TextBlock Text="SETTINGS" Foreground="#DA7756" FontWeight="Bold"
                                   FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                        <Button Click="ToggleSettingsPanel_Click" ToolTip="Collapse Settings"
                                HorizontalAlignment="Right">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource IconBtn}">
                                    <Setter Property="Content" Value="&#xE76C;"/>
                                    <Setter Property="FontSize" Value="12"/>
                                    <Setter Property="Foreground" Value="#666"/>
                                </Style>
                            </Button.Style>
                        </Button>
                    </DockPanel>
                <TabControl x:Name="MainTabs" Background="Transparent" BorderThickness="0">
                    <!-- Helper tab -->
                    <TabItem x:Name="HelperTabItem">
                        <TabItem.Header>
                            <TextBlock Text="Helper" Foreground="#AAA" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <DockPanel Margin="12">
                            <!-- Top controls -->
                            <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                                <TextBlock Text="Project Suggestions" Foreground="#DA7756" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,6"/>
                                <TextBlock Text="Analyze the current project and generate actionable suggestions for improvements."
                                           Foreground="#888" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,0,0,12"/>

                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Category" Foreground="#CCC" FontSize="12"
                                               FontFamily="Segoe UI" VerticalAlignment="Center"
                                               Margin="0,0,10,0"/>
                                    <ComboBox x:Name="HelperCategoryCombo" Width="160"
                                              FontSize="11" Padding="6,3" HorizontalAlignment="Left">
                                        <ComboBoxItem Content="General" Tag="General" IsSelected="True"/>
                                        <ComboBoxItem Content="Bug Fixes" Tag="BugFixes"/>
                                        <ComboBoxItem Content="New Features" Tag="NewFeatures"/>
                                        <ComboBoxItem Content="Extensions" Tag="Extensions"/>
                                        <ComboBoxItem Content="Rules" Tag="Rules"/>
                                    </ComboBox>
                                </DockPanel>

                                <StackPanel Orientation="Horizontal">
                                    <Button x:Name="GenerateSuggestionsBtn" Content="Add Suggestions"
                                            Click="GenerateSuggestions_Click"
                                            Background="#DA7756" Style="{StaticResource Btn}"
                                            FontSize="12" Padding="16,8"/>
                                    <Button x:Name="ClearSuggestionsBtn" Content="Clear All"
                                            Click="ClearSuggestions_Click"
                                            Style="{StaticResource GhostBtn}"
                                            FontSize="11" Padding="12,6" Margin="8,0,0,0"/>
                                    <TextBlock x:Name="HelperStatusText" Text=""
                                               Foreground="#888" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center" Margin="12,0,0,0"/>
                                </StackPanel>
                            </StackPanel>

                            <Border DockPanel.Dock="Top" Height="1" Background="#2C2C2C" Margin="0,0,0,8"/>

                            <!-- Suggestions list -->
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="SuggestionsListView">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="6" Padding="12,10" Margin="0,3"
                                                    Background="#1E1E1E" BorderThickness="1" BorderBrush="#2C2C2C">
                                                <Border.ContextMenu>
                                                    <ContextMenu>
                                                        <MenuItem Header="Copy" Tag="{Binding}"
                                                                  Click="CopySuggestion_Click"/>
                                                    </ContextMenu>
                                                </Border.ContextMenu>
                                                <DockPanel>
                                                    <StackPanel DockPanel.Dock="Right" VerticalAlignment="Center"
                                                                Margin="10,0,0,0">
                                                        <Button Content="Run" Tag="{Binding}"
                                                                Click="RunSuggestion_Click"
                                                                Background="#DA7756" Style="{StaticResource Btn}"
                                                                FontSize="11" Padding="14,5" Margin="0,0,0,4"/>
                                                        <Button Content="Save" Tag="{Binding}"
                                                                Click="SaveSuggestion_Click"
                                                                Style="{StaticResource GhostBtn}"
                                                                FontSize="10" Padding="10,3" Margin="0,0,0,4"/>
                                                        <Button Content="Remove" Tag="{Binding}"
                                                                Click="RemoveSuggestion_Click"
                                                                Style="{StaticResource GhostBtn}"
                                                                FontSize="10" Padding="10,3" Margin="0,0,0,4"/>
                                                        <Button Content="Ignore" Tag="{Binding}"
                                                                Click="IgnoreSuggestion_Click"
                                                                Style="{StaticResource GhostBtn}"
                                                                FontSize="10" Padding="10,3"/>
                                                    </StackPanel>
                                                    <StackPanel>
                                                        <DockPanel Margin="0,0,0,4">
                                                            <Border CornerRadius="3" Padding="6,2" Margin="0,0,8,0"
                                                                    VerticalAlignment="Center">
                                                                <Border.Style>
                                                                    <Style TargetType="Border">
                                                                        <Setter Property="Background" Value="#333"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Category}" Value="BugFixes">
                                                                                <Setter Property="Background" Value="#3A2020"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding Category}" Value="NewFeatures">
                                                                                <Setter Property="Background" Value="#1A3A20"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding Category}" Value="Extensions">
                                                                                <Setter Property="Background" Value="#1A2040"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding Category}" Value="Rules">
                                                                                <Setter Property="Background" Value="#2A2A1A"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Border.Style>
                                                                <TextBlock FontSize="10" FontFamily="Segoe UI"
                                                                           FontWeight="SemiBold">
                                                                    <TextBlock.Style>
                                                                        <Style TargetType="TextBlock">
                                                                            <Setter Property="Text" Value="{Binding Category}"/>
                                                                            <Setter Property="Foreground" Value="#999"/>
                                                                            <Style.Triggers>
                                                                                <DataTrigger Binding="{Binding Category}" Value="BugFixes">
                                                                                    <Setter Property="Foreground" Value="#E05555"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding Category}" Value="NewFeatures">
                                                                                    <Setter Property="Foreground" Value="#4EC969"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding Category}" Value="Extensions">
                                                                                    <Setter Property="Foreground" Value="#64B5F6"/>
                                                                                </DataTrigger>
                                                                                <DataTrigger Binding="{Binding Category}" Value="Rules">
                                                                                    <Setter Property="Foreground" Value="#D4C44D"/>
                                                                                </DataTrigger>
                                                                            </Style.Triggers>
                                                                        </Style>
                                                                    </TextBlock.Style>
                                                                </TextBlock>
                                                            </Border>
                                                            <TextBlock Text="{Binding Title}" Foreground="#DDD"
                                                                       FontSize="13" FontWeight="SemiBold"
                                                                       FontFamily="Segoe UI"
                                                                       TextTrimming="CharacterEllipsis"/>
                                                        </DockPanel>
                                                        <TextBlock Text="{Binding Description}" Foreground="#999"
                                                                   FontSize="11" FontFamily="Segoe UI"
                                                                   TextWrapping="Wrap"/>
                                                    </StackPanel>
                                                </DockPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </DockPanel>
                    </TabItem>
                    <!-- File Locks tab -->
                    <TabItem x:Name="FileLocksTabHeader">
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="File Locks" Foreground="#AAA" FontFamily="Segoe UI" FontSize="12"/>
                                <TextBlock x:Name="FileLockBadge" Text="0" Visibility="Collapsed"
                                           Foreground="#CC8800" FontSize="10" FontWeight="Bold"
                                           FontFamily="Segoe UI" Margin="4,0,0,0"
                                           VerticalAlignment="Center"/>
                            </StackPanel>
                        </TabItem.Header>
                        <DockPanel Margin="8">
                            <TextBlock DockPanel.Dock="Top" Text="Active file locks across all tasks"
                                       Foreground="#666" FontSize="11" FontFamily="Segoe UI"
                                       Margin="4,6,4,8"/>
                            <!-- Header row -->
                            <Grid DockPanel.Dock="Top" Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="160"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="90"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="70"/>
                                    <ColumnDefinition Width="70"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="FILE" Foreground="#666" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="1" Text="STATUS" Foreground="#666" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="2" Text="TOOL" Foreground="#666" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="3" Text="PATH" Foreground="#666" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="4" Text="TASK" Foreground="#666" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                                <TextBlock Grid.Column="5" Text="SINCE" Foreground="#666" FontSize="10"
                                           FontWeight="Bold" FontFamily="Segoe UI" Padding="8,4"/>
                            </Grid>
                            <Border DockPanel.Dock="Top" Height="1" Background="#2C2C2C" Margin="0,0,0,4"/>
                            <!-- Lock rows -->
                            <ScrollViewer VerticalScrollBarVisibility="Auto">
                                <ItemsControl x:Name="FileLocksListView">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="8,5" Margin="0,1" CornerRadius="4"
                                                    Background="#1E1E1E">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="160"/>
                                                        <ColumnDefinition Width="70"/>
                                                        <ColumnDefinition Width="90"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="70"/>
                                                        <ColumnDefinition Width="70"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding FileName}"
                                                               Foreground="#CCC" FontSize="11" FontFamily="Consolas"
                                                               TextTrimming="CharacterEllipsis"
                                                               ToolTip="{Binding OriginalPath}"/>
                                                    <TextBlock Grid.Column="1" Text="{Binding StatusText}"
                                                               FontSize="11" FontFamily="Consolas">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Foreground" Value="#4EC969"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsIgnored}" Value="True">
                                                                        <Setter Property="Foreground" Value="#CC8800"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                    <TextBlock Grid.Column="2" Text="{Binding ToolName}"
                                                               Foreground="#999" FontSize="11" FontFamily="Consolas"/>
                                                    <TextBlock Grid.Column="3" Text="{Binding OriginalPath}"
                                                               Foreground="#777" FontSize="11" FontFamily="Consolas"
                                                               TextTrimming="CharacterEllipsis" Margin="8,0,0,0"/>
                                                    <TextBlock Grid.Column="4" Text="{Binding OwnerTaskId, StringFormat='#{0}'}"
                                                               Foreground="#DA7756" FontSize="11" FontFamily="Consolas"/>
                                                    <TextBlock Grid.Column="5" Text="{Binding TimeText}"
                                                               Foreground="#666" FontSize="11" FontFamily="Consolas"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>
                        </DockPanel>
                    </TabItem>
                    <!-- Advanced tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock Text="Advanced" Foreground="#AAA" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel MaxWidth="600">
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="System Prompt" Foreground="#DA7756" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditSystemPromptToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditSystemPromptToggle_Changed"
                                                  Unchecked="EditSystemPromptToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="#888" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <TextBox x:Name="SystemPromptBox" AcceptsReturn="True" TextWrapping="Wrap"
                                         MinHeight="160" MaxHeight="300"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="#191919" Foreground="#CCC"
                                         CaretBrush="#CCC" BorderBrush="#333" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="10"
                                         IsReadOnly="True" Opacity="0.6"/>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="This prompt is prepended to every task. MCP instructions are added automatically when the MCP toggle is enabled."
                                               Foreground="#555" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="PromptEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button x:Name="ResetPromptBtn" Content="Reset" Click="ResetPrompt_Click"
                                                Style="{StaticResource GhostBtn}" Margin="0,0,6,0"
                                                Padding="12,4" FontSize="11"/>
                                        <Button x:Name="SavePromptBtn" Content="Save" Click="SavePrompt_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <Border Height="1" Background="#2C2C2C" Margin="0,20"/>

                                <!-- Short Description -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Short Description" Foreground="#DA7756" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditShortDescToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditShortDescToggle_Changed"
                                                  Unchecked="EditShortDescToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="#888" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <TextBox x:Name="ShortDescBox" AcceptsReturn="True" TextWrapping="Wrap"
                                         MinHeight="60" MaxHeight="160"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="#191919" Foreground="#CCC"
                                         CaretBrush="#CCC" BorderBrush="#333" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="10"
                                         IsReadOnly="True" Opacity="0.6"/>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="A brief summary of the active project, sent with each task."
                                               Foreground="#555" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="ShortDescEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button Content="Save" Click="SaveShortDesc_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <Border Height="1" Background="#2C2C2C" Margin="0,20"/>

                                <!-- Long Description -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Long Description" Foreground="#DA7756" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditLongDescToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditLongDescToggle_Changed"
                                                  Unchecked="EditLongDescToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="#888" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <TextBox x:Name="LongDescBox" AcceptsReturn="True" TextWrapping="Wrap"
                                         MinHeight="120" MaxHeight="300"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="#191919" Foreground="#CCC"
                                         CaretBrush="#CCC" BorderBrush="#333" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="10"
                                         IsReadOnly="True" Opacity="0.6"/>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="Detailed project description used when Extended Planning is enabled."
                                               Foreground="#555" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="LongDescEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button Content="Save" Click="SaveLongDesc_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <Button x:Name="RegenerateDescBtn" Content="Regenerate Descriptions"
                                        Click="RegenerateDescriptions_Click"
                                        Background="#DA7756" Style="{StaticResource Btn}"
                                        FontSize="12" Padding="16,8" Margin="0,16,0,0"
                                        HorizontalAlignment="Left"/>

                                <Border Height="1" Background="#2C2C2C" Margin="0,20"/>

                                <!-- Rule Instruction -->
                                <DockPanel Margin="0,0,0,8">
                                    <TextBlock Text="Rule Instruction" Foreground="#DA7756" FontWeight="Bold"
                                               FontSize="13" FontFamily="Segoe UI" VerticalAlignment="Center"/>
                                    <ToggleButton x:Name="EditRuleInstructionToggle"
                                                  Style="{StaticResource ToggleSwitch}" Margin="12,0,0,0"
                                                  Checked="EditRuleInstructionToggle_Changed"
                                                  Unchecked="EditRuleInstructionToggle_Changed">
                                        <TextBlock Text="Edit" Foreground="#888" FontSize="11" FontFamily="Segoe UI"/>
                                    </ToggleButton>
                                </DockPanel>
                                <TextBox x:Name="RuleInstructionBox" AcceptsReturn="True" TextWrapping="Wrap"
                                         MinHeight="60" MaxHeight="160"
                                         VerticalScrollBarVisibility="Auto"
                                         Background="#191919" Foreground="#CCC"
                                         CaretBrush="#CCC" BorderBrush="#333" BorderThickness="1"
                                         FontSize="12" FontFamily="Consolas" Padding="10"
                                         IsReadOnly="True" Opacity="0.6"/>
                                <DockPanel Margin="0,6,0,0">
                                    <TextBlock Text="Project-specific rules passed with every prompt."
                                               Foreground="#555" FontSize="11" FontFamily="Segoe UI"
                                               VerticalAlignment="Center"/>
                                    <StackPanel x:Name="RuleInstructionEditButtons" Orientation="Horizontal"
                                                HorizontalAlignment="Right" Visibility="Collapsed">
                                        <Button Content="Save" Click="SaveRuleInstruction_Click"
                                                Style="{StaticResource SuccessBtn}"
                                                Padding="12,4" FontSize="11"/>
                                    </StackPanel>
                                </DockPanel>

                                <!-- Project Rules List -->
                                <TextBlock Text="Project Rules" Foreground="#CCC" FontWeight="SemiBold"
                                           FontSize="12" FontFamily="Segoe UI" Margin="0,16,0,6"/>
                                <ItemsControl x:Name="ProjectRulesList">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border CornerRadius="4" Padding="8,5" Margin="0,2"
                                                    Background="#1E1E1E" BorderThickness="1" BorderBrush="#2C2C2C">
                                                <DockPanel>
                                                    <Button Content="&#xE711;" FontFamily="Segoe MDL2 Assets"
                                                            FontSize="9" Foreground="#888" Background="Transparent"
                                                            BorderThickness="0" Cursor="Hand" Padding="4,2"
                                                            DockPanel.Dock="Right" VerticalAlignment="Center"
                                                            Tag="{Binding}" Click="RemoveProjectRule_Click"/>
                                                    <TextBlock Text="{Binding}" Foreground="#CCC" FontSize="11"
                                                               FontFamily="Segoe UI" TextWrapping="Wrap"
                                                               VerticalAlignment="Center"/>
                                                </DockPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                                <DockPanel Margin="0,8,0,0">
                                    <Button Content="Add" Click="AddProjectRule_Click"
                                            Style="{StaticResource Btn}" DockPanel.Dock="Right"
                                            Background="#DA7756" Padding="14,6" FontSize="11" Margin="6,0,0,0"/>
                                    <TextBox x:Name="NewRuleInput"
                                             Background="#191919" Foreground="#CCC"
                                             CaretBrush="#CCC" BorderBrush="#333" BorderThickness="1"
                                             FontSize="12" FontFamily="Segoe UI" Padding="8,6"
                                             KeyDown="NewRuleInput_KeyDown"/>
                                </DockPanel>

                                <Border Height="1" Background="#2C2C2C" Margin="0,20"/>

                                <TextBlock Text="Defaults" Foreground="#DA7756" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,12"/>
                                <ToggleButton x:Name="DefaultNoGitWriteToggle" IsChecked="True"
                                              Style="{StaticResource ToggleSwitch}" Margin="0,0,0,14">
                                    <TextBlock Text="No Git Write by default" Foreground="#CCC"
                                               FontSize="12" FontFamily="Segoe UI"/>
                                </ToggleButton>

                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="Max concurrent tasks" Foreground="#CCC"
                                               FontSize="12" FontFamily="Segoe UI" VerticalAlignment="Center"
                                               Margin="0,0,12,0"/>
                                    <TextBox x:Name="MaxConcurrentTasksBox" Width="60" Text="10"
                                             Background="#191919" Foreground="#CCC"
                                             CaretBrush="#CCC" BorderBrush="#333" BorderThickness="1"
                                             FontSize="12" FontFamily="Segoe UI" Padding="6,4"
                                             TextAlignment="Center"
                                             LostFocus="MaxConcurrentTasks_Changed"
                                             KeyDown="MaxConcurrentTasks_KeyDown"/>
                                </StackPanel>

                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="History retention" Foreground="#CCC"
                                               FontSize="12" FontFamily="Segoe UI" VerticalAlignment="Center"
                                               Margin="0,0,12,0"/>
                                    <ComboBox x:Name="HistoryRetentionCombo" Width="120"
                                              SelectionChanged="HistoryRetention_Changed">
                                        <ComboBoxItem Content="6 hours" Tag="6"/>
                                        <ComboBoxItem Content="12 hours" Tag="12"/>
                                        <ComboBoxItem Content="24 hours" Tag="24" IsSelected="True"/>
                                        <ComboBoxItem Content="3 days" Tag="72"/>
                                        <ComboBoxItem Content="7 days" Tag="168"/>
                                    </ComboBox>
                                </StackPanel>

                                <Border Height="1" Background="#2C2C2C" Margin="0,10,0,10"/>

                                <TextBlock Text="Diagnostics" Foreground="#DA7756" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,8"/>
                                <Button x:Name="ViewLogsBtn" Content="View Application Log"
                                        Click="ViewLogs_Click"
                                        Style="{StaticResource SecondaryBtn}"
                                        HorizontalAlignment="Left"
                                        Padding="14,7" FontSize="12"/>

                                <Border Height="1" Background="#2C2C2C" Margin="0,10,0,20"/>

                                <TextBlock Text="About" Foreground="#666" FontSize="11" FontFamily="Segoe UI"/>
                                <TextBlock Text="Agentic Engine - Claude Code Task Manager" Foreground="#555"
                                           FontSize="11" FontFamily="Segoe UI" Margin="0,4,0,0"/>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                    <!-- Gemini tab -->
                    <TabItem>
                        <TabItem.Header>
                            <TextBlock Text="Gemini" Foreground="#AAA" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="16">
                            <StackPanel MaxWidth="600">
                                <TextBlock Text="Gemini Image Generation" Foreground="#4EA8DB" FontWeight="Bold"
                                           FontSize="13" FontFamily="Segoe UI" Margin="0,0,0,8"/>
                                <TextBlock Text="Configure Google Gemini API for AI image generation. When Gemini is selected as the model, prompts generate images instead of code."
                                           Foreground="#888" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"
                                           Margin="0,0,0,16"/>

                                <TextBlock Text="API Key" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <DockPanel Margin="0,0,0,4">
                                    <Button x:Name="SaveGeminiKeyBtn" Content="Save" Click="SaveGeminiKey_Click"
                                            Style="{StaticResource Btn}" DockPanel.Dock="Right"
                                            Background="#4EA8DB" Padding="14,6" FontSize="11" Margin="6,0,0,0"/>
                                    <TextBox x:Name="GeminiApiKeyBox"
                                             Background="#191919" Foreground="#CCC"
                                             CaretBrush="#CCC" BorderBrush="#333" BorderThickness="1"
                                             FontSize="12" FontFamily="Consolas" Padding="8,6"/>
                                </DockPanel>
                                <TextBlock x:Name="GeminiKeyStatus" Text="" Foreground="#5CB85C" FontSize="11"
                                           FontFamily="Segoe UI" Margin="0,4,0,0"/>
                                <TextBlock Foreground="#555" FontSize="11" FontFamily="Segoe UI" Margin="0,8,0,0"
                                           TextWrapping="Wrap">
                                    Get a free API key from Google AI Studio:
                                    <TextBlock.ToolTip>https://aistudio.google.com/apikey</TextBlock.ToolTip>
                                </TextBlock>
                                <TextBlock Text="https://aistudio.google.com/apikey" Foreground="#4EA8DB"
                                           FontSize="11" FontFamily="Consolas" Margin="0,2,0,0"
                                           Cursor="Hand" MouseDown="GeminiApiLink_Click"
                                           TextDecorations="Underline"/>

                                <Border Height="1" Background="#2C2C2C" Margin="0,20"/>

                                <TextBlock Text="Model" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <ComboBox x:Name="GeminiModelCombo"
                                          FontSize="11" Padding="6,3" MinWidth="280"
                                          HorizontalAlignment="Left" Margin="0,0,0,4"
                                          SelectionChanged="GeminiModelCombo_Changed"/>
                                <TextBlock Text="Supports native image generation with text prompts. Images are saved to AppData."
                                           Foreground="#666" FontSize="11" FontFamily="Segoe UI" TextWrapping="Wrap"/>

                                <Border Height="1" Background="#2C2C2C" Margin="0,20"/>

                                <TextBlock Text="Image Storage" Foreground="#CCC" FontSize="12" FontFamily="Segoe UI"
                                           Margin="0,0,0,6"/>
                                <TextBlock Text="%LOCALAPPDATA%\AgenticEngine\gemini_images\" Foreground="#888"
                                           FontSize="11" FontFamily="Consolas" Margin="0,0,0,6"/>
                                <Button x:Name="OpenGeminiImagesBtn" Content="Open Images Folder"
                                        Click="OpenGeminiImages_Click"
                                        Style="{StaticResource GhostBtn}" Foreground="#4EA8DB"
                                        FontSize="11" HorizontalAlignment="Left"/>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>
                    <!-- Games tab -->
                    <TabItem x:Name="GamesTabItem">
                        <TabItem.Header>
                            <TextBlock Text="Games" Foreground="#AAA" FontFamily="Segoe UI" FontSize="12"/>
                        </TabItem.Header>
                        <Grid>
                            <!-- Game selector (shown when no game is active) -->
                            <ScrollViewer x:Name="GameSelectorPanel" VerticalScrollBarVisibility="Auto" Padding="12">
                                <WrapPanel x:Name="GameIconsPanel" Margin="8"/>
                            </ScrollViewer>
                            <!-- Game host (shown when a game is running) -->
                            <ContentControl x:Name="GameHost" Visibility="Collapsed"/>
                        </Grid>
                    </TabItem>
                </TabControl>
                </DockPanel>
            </Border>

        <!-- Horizontal Splitter: Output ↔ Terminal -->
        <GridSplitter x:Name="TerminalSplitter" Grid.Row="3" Grid.Column="2" Grid.ColumnSpan="3" Style="{StaticResource HorizontalSplitter}" Visibility="Collapsed"/>

        <!-- ═══ TERMINAL (6) ═══ -->
        <Border Grid.Row="4" Grid.Column="2" Grid.ColumnSpan="3" Background="#222222" CornerRadius="8" Padding="4"
                BorderThickness="1">
            <Border.BorderBrush>
                <SolidColorBrush x:Name="TerminalPanelBorder" Color="#2C2C2C"/>
            </Border.BorderBrush>
            <Border.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <ColorAnimation Storyboard.TargetName="TerminalPanelBorder"
                                            Storyboard.TargetProperty="Color"
                                            To="#3A3A3A" Duration="0:0:0.2"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <ColorAnimation Storyboard.TargetName="TerminalPanelBorder"
                                            Storyboard.TargetProperty="Color"
                                            To="#2C2C2C" Duration="0:0:0.3"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>
            <DockPanel>
                <!-- Root path display (very bottom) -->
                <Border x:Name="TerminalRootBar" DockPanel.Dock="Bottom" Background="#181818" CornerRadius="0,0,6,6" Visibility="Collapsed"
                        Padding="8,3" Margin="0,2,0,0">
                    <TextBlock x:Name="TerminalRootPath"
                               Foreground="#666666" FontFamily="Consolas" FontSize="10"
                               TextTrimming="CharacterEllipsis"
                               ToolTip="{Binding Text, RelativeSource={RelativeSource Self}}"/>
                </Border>
                <DockPanel x:Name="TerminalInputBar" DockPanel.Dock="Bottom" Margin="4,2,4,4" Visibility="Collapsed">
                    <Button x:Name="TerminalInterruptBtn" Content="Ctrl+C" DockPanel.Dock="Right"
                            Style="{StaticResource DangerBtn}"
                            FontWeight="Bold" FontSize="11"
                            Padding="10,4" Margin="4,0,0,0"
                            Click="TerminalInterrupt_Click" ToolTip="Send interrupt (Ctrl+C)"/>
                    <Button x:Name="TerminalSendBtn" Content="Send" DockPanel.Dock="Right"
                            Background="{StaticResource Accent}" Style="{StaticResource Btn}"
                            FontWeight="Bold" FontSize="12"
                            Padding="14,4" Margin="4,0,0,0"
                            Click="TerminalSend_Click"/>
                    <TextBox x:Name="TerminalInput"
                             Background="#141414" Foreground="#B0B0B0" CaretBrush="#B0B0B0"
                             BorderBrush="#2A2A2A" BorderThickness="1"
                             FontFamily="Consolas" FontSize="12"
                             Padding="8,4" VerticalContentAlignment="Center"
                             PreviewKeyDown="TerminalInput_PreviewKeyDown"/>
                </DockPanel>
                <DockPanel DockPanel.Dock="Top" Margin="8,4,8,2">
                    <Button x:Name="TerminalCollapseBtn" Content="&#xE70E;"
                            Style="{StaticResource IconBtn}" DockPanel.Dock="Left"
                            VerticalAlignment="Center" Margin="0,0,4,0"
                            Click="TerminalCollapse_Click" ToolTip="Expand terminal"/>
                    <TextBlock Text="TERMINAL" Foreground="#DA7756" FontWeight="Bold"
                               FontSize="10" FontFamily="Segoe UI" VerticalAlignment="Center"
                               Margin="0,0,8,0" MouseLeftButtonDown="TerminalHeader_MouseDown" Cursor="Hand"/>
                    <StackPanel x:Name="TerminalTabBar" Orientation="Horizontal" VerticalAlignment="Center" Visibility="Collapsed"/>
                </DockPanel>
                <TextBox x:Name="TerminalOutput" IsReadOnly="True" TextWrapping="Wrap"
                         VerticalScrollBarVisibility="Auto"
                         Background="#0A0A0A" Foreground="#B0B0B0"
                         FontFamily="Consolas" FontSize="12"
                         BorderThickness="0" Padding="8,4" Visibility="Collapsed"/>
            </DockPanel>
        </Border>

        <!-- ═══ STATUS BAR ═══ -->
        <Border Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="5" Background="#222222" CornerRadius="6" Padding="12,7" Margin="0,8,0,0"
                BorderThickness="1">
            <Border.BorderBrush>
                <SolidColorBrush x:Name="StatusBarBorder" Color="#2C2C2C"/>
            </Border.BorderBrush>
            <Border.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <ColorAnimation Storyboard.TargetName="StatusBarBorder"
                                            Storyboard.TargetProperty="Color"
                                            To="#3A3A3A" Duration="0:0:0.2"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <ColorAnimation Storyboard.TargetName="StatusBarBorder"
                                            Storyboard.TargetProperty="Color"
                                            To="#2C2C2C" Duration="0:0:0.3"/>
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Border.Triggers>
            <TextBlock x:Name="StatusText" Foreground="#999" FontSize="11" FontFamily="Segoe UI"
                       TextTrimming="CharacterEllipsis"/>
        </Border>

        <!-- Loading overlay shown during async startup -->
        <Border x:Name="LoadingOverlay" Grid.RowSpan="6" Grid.ColumnSpan="5"
                Background="#CC191919" CornerRadius="8"
                Visibility="Visible" Panel.ZIndex="1000">
            <TextBlock Text="Loading..." Foreground="#888"
                       FontSize="16" FontFamily="Segoe UI"
                       HorizontalAlignment="Center" VerticalAlignment="Center"/>
        </Border>
    </Grid>
</Window>
